<%- include('../partials/header') %>

    <div class="pt-20 pb-12 bg-gray-50 min-h-screen">
        <div class="container mx-auto px-4">
            <!-- Page Header -->
            <div class="bg-white rounded-2xl shadow-lg p-8 mb-8">
                <div class="flex items-center justify-between mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">
                        <i class="fas fa-ticket-alt text-primary mr-3"></i>My Bookings
                    </h1>
                    <a href="/rides/search"
                        class="bg-primary hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold transition">
                        <i class="fas fa-plus-circle mr-2"></i>Book New Ride
                    </a>
                </div>

                <!-- Status Filter Tabs -->
                <div class="flex flex-wrap gap-2">
                    <a href="/bookings/my-bookings?status=all"
                        class="px-6 py-2 rounded-lg font-semibold transition <%= currentStatus === 'all' ? 'bg-primary text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200' %>">
                        All Bookings
                    </a>
                    <a href="/bookings/my-bookings?status=pending"
                        class="px-6 py-2 rounded-lg font-semibold transition <%= currentStatus === 'pending' ? 'bg-yellow-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200' %>">
                        <i class="fas fa-clock mr-2"></i>Pending
                    </a>
                    <a href="/bookings/my-bookings?status=confirmed"
                        class="px-6 py-2 rounded-lg font-semibold transition <%= currentStatus === 'confirmed' ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200' %>">
                        <i class="fas fa-check-circle mr-2"></i>Confirmed
                    </a>
                    <a href="/bookings/my-bookings?status=in-progress"
                        class="px-6 py-2 rounded-lg font-semibold transition <%= currentStatus === 'in-progress' ? 'bg-green-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200' %>">
                        <i class="fas fa-route mr-2"></i>In Progress
                    </a>
                    <a href="/bookings/my-bookings?status=completed"
                        class="px-6 py-2 rounded-lg font-semibold transition <%= currentStatus === 'completed' ? 'bg-purple-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200' %>">
                        <i class="fas fa-flag-checkered mr-2"></i>Completed
                    </a>
                    <a href="/bookings/my-bookings?status=cancelled"
                        class="px-6 py-2 rounded-lg font-semibold transition <%= currentStatus === 'cancelled' ? 'bg-red-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200' %>">
                        <i class="fas fa-times-circle mr-2"></i>Cancelled
                    </a>
                </div>
            </div>

            <!-- Bookings List -->
            <div class="space-y-6">
                <% if (bookings.length===0) { %>
                    <!-- No Bookings -->
                    <div class="bg-white rounded-2xl shadow-lg p-12 text-center">
                        <i class="fas fa-inbox text-gray-300 text-6xl mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-600 mb-2">No bookings found</h3>
                        <p class="text-gray-500 mb-6">
                            <% if (currentStatus==='all' ) { %>
                                You haven't booked any rides yet
                                <% } else { %>
                                    No <%= currentStatus %> bookings at the moment
                                        <% } %>
                        </p>
                        <a href="/rides/search"
                            class="inline-block bg-primary hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold transition">
                            <i class="fas fa-search mr-2"></i>Find Rides
                        </a>
                    </div>
                    <% } else { %>
                        <!-- Booking Cards -->
                        <% bookings.forEach(booking=> { %>
                            <div class="bg-white rounded-2xl shadow-lg hover:shadow-xl transition p-6">
                                <div class="flex items-start justify-between mb-4">
                                    <!-- Status Badge -->
                                    <div>
                                        <% let statusClass='bg-gray-100 text-gray-700' ; let
                                            statusIcon='fas fa-question-circle' ; let
                                            statusText=booking.status.replace('_', ' ' ); const
                                            isPaymentPaid=booking.payment && booking.payment.status==='PAID' ; const
                                            isDroppedOff=booking.status==='DROPPED_OFF' ; const
                                            isPickedUp=booking.status==='PICKED_UP' ; if ((isDroppedOff || isPickedUp)
                                            && isPaymentPaid) { statusClass='bg-green-100 text-green-700' ;
                                            statusIcon='fas fa-check-circle' ; statusText='Completed' ; } else if
                                            (isDroppedOff && !isPaymentPaid) {
                                            statusClass='bg-yellow-100 text-yellow-700' ; statusIcon='fas fa-clock' ;
                                            statusText='Payment Pending' ; } else { switch(booking.status) {
                                            case 'PENDING' : statusClass='bg-yellow-100 text-yellow-700' ;
                                            statusIcon='fas fa-clock' ; break; case 'CONFIRMED' :
                                            statusClass='bg-blue-100 text-blue-700' ; statusIcon='fas fa-check-circle' ;
                                            statusText='Confirmed' ; break; case 'PICKUP_PENDING' :
                                            statusClass='bg-blue-100 text-blue-700' ; statusIcon='fas fa-hourglass-half'
                                            ; statusText='Ready for Pickup' ; break; case 'PICKED_UP' :
                                            statusClass='bg-purple-100 text-purple-700' ; statusIcon='fas fa-user-check'
                                            ; statusText='On Board' ; break; case 'IN_PROGRESS' :
                                            statusClass='bg-green-100 text-green-700' ; statusIcon='fas fa-route' ;
                                            statusText='In Progress' ; break; case 'COMPLETED' :
                                            statusClass='bg-green-100 text-green-700' ; statusIcon='fas fa-check-circle'
                                            ; statusText='Completed' ; break; case 'CANCELLED' :
                                            statusClass='bg-red-100 text-red-700' ; statusIcon='fas fa-times-circle' ;
                                            break; } } %>
                                            <span
                                                class="<%= statusClass %> px-4 py-2 rounded-full text-sm font-semibold inline-block">
                                                <i class="<%= statusIcon %> mr-2"></i>
                                                <%= statusText %>
                                            </span>
                                            <p class="text-gray-500 text-sm mt-2">
                                                Booking ID: #<%= booking._id.toString().slice(-8).toUpperCase() %>
                                            </p>
                                    </div>

                                    <!-- Price -->
                                    <div class="text-right">
                                        <div class="text-3xl font-bold text-primary mb-1">â‚¹<%= booking.totalAmount %>
                                        </div>
                                        <p class="text-gray-600 text-sm">
                                            <%= booking.seatsBooked %> seat(s)
                                        </p>
                                    </div>
                                </div>

                                <!-- Ride Details -->
                                <% if (booking.ride) { %>
                                    <div class="border-t pt-4 mb-4">
                                        <!-- Driver Info -->
                                        <div class="flex items-center mb-4">
                                            <img src="<%= booking.ride.rider?.profilePhoto || booking.ride.rider?.profile?.photo || '/images/default-avatar.png' %>"
                                                class="w-12 h-12 rounded-full mr-4"
                                                alt="<%= getUserName(booking.ride.rider) %>">
                                            <div>
                                                <h3 class="font-semibold text-gray-800">
                                                    <%= getUserName(booking.ride.rider) %>
                                                </h3>
                                                <div class="flex items-center text-sm text-gray-600">
                                                    <div class="text-yellow-400 mr-2">
                                                        <% const rating=booking.ride.rider?.rating?.overall || 0;
                                                            for(let i=1; i <=5; i++) { %>
                                                            <% if(i <=Math.floor(rating)) { %>
                                                                <i class="fas fa-star"></i>
                                                                <% } else if(i - 0.5 <=rating) { %>
                                                                    <i class="fas fa-star-half-alt"></i>
                                                                    <% } else { %>
                                                                        <i class="far fa-star"></i>
                                                                        <% } %>
                                                                            <% } %>
                                                    </div>
                                                    <span>
                                                        <%= rating.toFixed(1) %>
                                                    </span>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Route -->
                                        <div class="space-y-2 mb-4">
                                            <div class="flex items-center text-gray-700">
                                                <i class="fas fa-map-marker-alt text-green-600 w-6"></i>
                                                <span class="ml-2">
                                                    <%= booking.pickupPoint?.address ||
                                                        booking.ride?.route?.start?.address ||
                                                        booking.ride?.route?.start?.name || 'N/A' %>
                                                </span>
                                            </div>
                                            <div class="flex items-center text-gray-400 ml-6">
                                                <i class="fas fa-ellipsis-v"></i>
                                            </div>
                                            <div class="flex items-center text-gray-700">
                                                <i class="fas fa-map-marker-alt text-red-600 w-6"></i>
                                                <span class="ml-2">
                                                    <%= booking.dropoffPoint?.address ||
                                                        booking.ride?.route?.destination?.address ||
                                                        booking.ride?.route?.destination?.name || 'N/A' %>
                                                </span>
                                            </div>
                                        </div>

                                        <!-- Ride Info -->
                                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm text-gray-600">
                                            <div>
                                                <i class="fas fa-calendar text-primary mr-2"></i>
                                                <%= new
                                                    Date(booking.ride.schedule.departureDateTime).toLocaleDateString()
                                                    %>
                                            </div>
                                            <div>
                                                <i class="fas fa-clock text-primary mr-2"></i>
                                                <%= booking.ride.schedule.time %>
                                            </div>
                                            <% if (booking.ride.rider?.vehicle) { %>
                                                <div>
                                                    <i class="fas fa-car text-primary mr-2"></i>
                                                    <%= booking.ride.rider.vehicle.model %> (<%=
                                                            booking.ride.rider.vehicle.color %>)
                                                </div>
                                                <% } %>
                                                    <% if (booking.ride.rider?.vehicle?.registrationNumber) { %>
                                                        <div>
                                                            <i class="fas fa-id-card text-primary mr-2"></i>
                                                            <%= booking.ride.rider.vehicle.registrationNumber %>
                                                        </div>
                                                        <% } %>
                                                            <% if (booking.pickupPoint) { %>
                                                                <div>
                                                                    <i
                                                                        class="fas fa-location-arrow text-primary mr-2"></i>
                                                                    Pickup confirmed
                                                                </div>
                                                                <% } %>
                                        </div>
                                    </div>
                                    <% } %>

                                        <!-- Actions -->
                                        <div class="border-t pt-4 flex flex-wrap gap-3">
                                            <a href="/bookings/<%= booking._id %>"
                                                class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-semibold transition">
                                                <i class="fas fa-eye mr-2"></i>View Details
                                            </a>

                                            <% if (
                                                booking.status==='CONFIRMED' ||
                                                booking.status==='PICKUP_PENDING' ||
                                                booking.status==='PICKED_UP' ||
                                                booking.status==='IN_TRANSIT' ||
                                                booking.status==='DROPPING_OFF' ||
                                                booking.status==='DROPOFF_PENDING'
                                            ) { %>
                                                <a href="/tracking/<%= booking._id %>"
                                                    class="px-4 py-2 bg-primary hover:bg-green-700 text-white rounded-lg font-semibold transition">
                                                    <i class="fas fa-map-marked-alt mr-2"></i>Live Track
                                                </a>
                                            <% } %>

                                                    <% if (booking.status==='CONFIRMED' ) { %>
                                                        <a href="/chat/<%= booking.ride?._id %>"
                                                            class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-semibold transition">
                                                            <i class="fas fa-comments mr-2"></i>Chat
                                                        </a>
                                                        <% } %>

                                                            <% if (booking.status==='PENDING' ) { %>
                                                                <button onclick="cancelBooking('<%= booking._id %>')"
                                                                    class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-semibold transition">
                                                                    <i class="fas fa-times mr-2"></i>Cancel
                                                                </button>
                                                                <% } %>

                                                                    <% if (booking.status==='COMPLETED' &&
                                                                        !booking.reviews?.passengerReviewed) { %>
                                                                        <a href="/reviews/booking/<%= booking._id %>"
                                                                            class="px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg font-semibold transition">
                                                                            <i class="fas fa-star mr-2"></i>Write Review
                                                                        </a>
                                                                        <% } %>

                                                                            <% if (booking.status==='COMPLETED' &&
                                                                                booking.reviews?.passengerReviewed) { %>
                                                                                <span
                                                                                    class="px-4 py-2 bg-green-100 text-green-700 rounded-lg font-semibold">
                                                                                    <i
                                                                                        class="fas fa-check-circle mr-2"></i>Reviewed
                                                                                </span>
                                                                                <% } %>
                                        </div>

                                        <!-- Booking Time -->
                                        <p class="text-gray-400 text-xs mt-4">
                                            <i class="fas fa-clock mr-1"></i>
                                            Booked <%= new Date(booking.createdAt).toLocaleString() %>
                                        </p>
                            </div>
                            <% }); %>

                                <!-- Pagination -->
                                <% if (pagination.totalPages> 1) { %>
                                    <div class="flex justify-center items-center space-x-2 mt-8">
                                        <% if (pagination.hasPrevPage) { %>
                                            <a href="?status=<%= currentStatus %>&page=<%= pagination.currentPage - 1 %>"
                                                class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                                                <i class="fas fa-chevron-left"></i>
                                            </a>
                                            <% } %>

                                                <% for(let i=1; i <=pagination.totalPages; i++) { %>
                                                    <% if (i===pagination.currentPage) { %>
                                                        <span
                                                            class="px-4 py-2 bg-primary text-white rounded-lg font-semibold">
                                                            <%= i %>
                                                        </span>
                                                        <% } else if (i===1 || i===pagination.totalPages || (i>=
                                                            pagination.currentPage - 1 && i <= pagination.currentPage +
                                                                1)) { %>
                                                                <a href="?status=<%= currentStatus %>&page=<%= i %>"
                                                                    class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                                                                    <%= i %>
                                                                </a>
                                                                <% } else if (i===pagination.currentPage - 2 ||
                                                                    i===pagination.currentPage + 2) { %>
                                                                    <span class="px-4 py-2">...</span>
                                                                    <% } %>
                                                                        <% } %>

                                                                            <% if (pagination.hasNextPage) { %>
                                                                                <a href="?status=<%= currentStatus %>&page=<%= pagination.currentPage + 1 %>"
                                                                                    class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                                                                                    <i class="fas fa-chevron-right"></i>
                                                                                </a>
                                                                                <% } %>
                                    </div>
                                    <% } %>
                                        <% } %>
            </div>
        </div>
    </div>

    <script>
        async function cancelBooking(bookingId) {
            if (!confirm('Are you sure you want to cancel this booking?')) {
                return;
            }

            try {
                const response = await fetch(`/api/bookings/${bookingId}/cancel`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    LANEApp.showAlert('Booking cancelled successfully', 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    const error = await response.json();
                    LANEApp.showAlert(error.message || 'Failed to cancel booking', 'error');
                }
            } catch (error) {
                LANEApp.showAlert('Failed to cancel booking', 'error');
            }
        }
    </script>

    <%- include('../partials/footer') %>