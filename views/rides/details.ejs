<%- include('../partials/header') %>

    <!-- Socket.IO for real-time updates -->
    <script src="/socket.io/socket.io.js"></script>

    <div class="max-w-6xl mx-auto px-4 py-8">
        <!-- Back Button -->
        <a href="/rides/my-rides" class="inline-flex items-center text-primary hover:text-green-700 mb-6">
            <i class="fas fa-arrow-left mr-2"></i>Back to My Rides
        </a>

        <!-- Ride Header -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">
                        <i class="fas fa-route text-primary mr-2"></i>Ride Details
                    </h1>
                    <% let statusClass='' ; let statusIcon='' ; switch(ride.status) { case 'ACTIVE' :
                        statusClass='bg-green-100 text-green-800' ; statusIcon='fas fa-check-circle' ; break;
                        case 'IN_PROGRESS' : statusClass='bg-blue-100 text-blue-800' ; statusIcon='fas fa-car' ; break;
                        case 'COMPLETED' : statusClass='bg-gray-100 text-gray-800' ; statusIcon='fas fa-flag-checkered'
                        ; break; case 'CANCELLED' : statusClass='bg-red-100 text-red-800' ;
                        statusIcon='fas fa-times-circle' ; break; case 'EXPIRED' :
                        statusClass='bg-yellow-100 text-yellow-800' ; statusIcon='fas fa-clock' ; break; } %>
                        <span class="<%= statusClass %> px-4 py-2 rounded-full text-sm font-semibold inline-block">
                            <i class="<%= statusIcon %> mr-2"></i>
                            <%= ride.status %>
                        </span>
                </div>

                <% if (ride.rider._id.toString()===user._id.toString() && ride.status==='ACTIVE' ) { %>
                    <div class="flex gap-2">
                        <% if (confirmedBookings && confirmedBookings.length> 0) { %>
                            <button onclick="startRide()"
                                class="px-6 py-3 bg-gradient-to-r from-green-600 to-blue-600 hover:from-green-700 hover:to-blue-700 text-white rounded-lg transition font-bold shadow-lg transform hover:scale-105">
                                <i class="fas fa-play-circle mr-2"></i>Start Ride
                            </button>
                            <% } %>
                                <button onclick="cancelRide()"
                                    class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition">
                                    <i class="fas fa-times mr-2"></i>Cancel Ride
                                </button>
                    </div>
                    <% } %>
            </div>

            <!-- Route Information -->
            <div class="border-t border-b py-6 mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">
                    <i class="fas fa-map-marked-alt text-primary mr-2"></i>Route
                </h2>
                <div class="space-y-4">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-map-marker-alt text-green-600 text-xl"></i>
                        </div>
                        <div class="ml-4 flex-1">
                            <p class="text-sm text-gray-500">Pick-up Location</p>
                            <p class="text-lg font-semibold text-gray-800">
                                <%= ride.route?.start?.name || ride.route?.start?.address %>
                            </p>
                        </div>
                    </div>

                    <div class="ml-6 border-l-2 border-gray-300 pl-6 py-2">
                        <div class="text-gray-600 flex items-center gap-4">
                            <span><i class="fas fa-road mr-2"></i>
                                <%= ride.route?.distance ? ride.route.distance.toFixed(1) + ' km' : 'N/A' %>
                            </span>
                            <span><i class="fas fa-clock mr-2"></i>
                                <%= ride.route?.duration ? Math.round(ride.route.duration) + ' mins' : 'N/A' %>
                            </span>
                        </div>
                    </div>

                    <div class="flex items-center">
                        <div class="flex-shrink-0 w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-map-marker-alt text-red-600 text-xl"></i>
                        </div>
                        <div class="ml-4 flex-1">
                            <p class="text-sm text-gray-500">Drop-off Location</p>
                            <p class="text-lg font-semibold text-gray-800">
                                <%= ride.route?.destination?.name || ride.route?.destination?.address %>
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Schedule Information -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="bg-gray-50 rounded-lg p-4">
                    <h3 class="font-semibold text-gray-700 mb-2">
                        <i class="fas fa-calendar-alt text-primary mr-2"></i>Departure
                    </h3>
                    <p class="text-lg">
                        <%= new Date(ride.schedule?.departureDateTime || ride.schedule?.date).toLocaleString('en-US', {
                            weekday: 'long' , year: 'numeric' , month: 'long' , day: 'numeric' , hour: '2-digit' ,
                            minute: '2-digit' }) %>
                    </p>
                </div>

                <div class="bg-gray-50 rounded-lg p-4">
                    <h3 class="font-semibold text-gray-700 mb-2">
                        <i class="fas fa-users text-primary mr-2"></i>Seats
                    </h3>
                    <p class="text-lg">
                        <%= ride.pricing?.availableSeats || 0 %> / <%= ride.pricing?.totalSeats || 0 %> available
                    </p>
                </div>
            </div>

            <!-- Pricing -->
            <div class="bg-primary bg-opacity-10 rounded-lg p-6 mb-6">
                <% if (ride.rider._id.toString()===user._id.toString()) { %>
                    <!-- Rider view: Show both price and earnings -->
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 mb-1">Price per Seat</p>
                            <p class="text-3xl font-bold text-primary">₹<%= ride.pricing?.pricePerSeat || 0 %>
                            </p>
                        </div>
                        <div class="text-right">
                            <p class="text-gray-600 mb-1">Total Earnings</p>
                            <p class="text-2xl font-bold text-gray-800">₹<%= ride.pricing?.totalEarnings || 0 %>
                            </p>
                        </div>
                    </div>
                    <% } else { %>
                        <!-- Passenger view: Only show price per seat -->
                        <div class="text-center">
                            <p class="text-gray-600 mb-1">Price per Seat</p>
                            <p class="text-4xl font-bold text-primary">₹<%= ride.pricing?.pricePerSeat || 0 %>
                            </p>
                        </div>
                        <% } %>
            </div>

            <!-- Preferences -->
            <div class="mb-6">
                <h3 class="font-semibold text-gray-700 mb-3">
                    <i class="fas fa-cog text-primary mr-2"></i>Ride Preferences
                </h3>
                <div class="flex flex-wrap gap-2">
                    <span class="px-3 py-1 bg-gray-100 rounded-full text-sm">
                        <i
                            class="fas fa-<%= ride.preferences?.gender === 'FEMALE_ONLY' ? 'female' : 'users' %> mr-1"></i>
                        <%= ride.preferences?.gender || 'Any' %>
                    </span>
                    <span class="px-3 py-1 bg-gray-100 rounded-full text-sm">
                        <i class="fas fa-smoking<%= ride.preferences?.smoking ? '' : '-ban' %> mr-1"></i>
                        <%= ride.preferences?.smoking ? 'Smoking Allowed' : 'No Smoking' %>
                    </span>
                    <span class="px-3 py-1 bg-gray-100 rounded-full text-sm">
                        <i class="fas fa-paw mr-1"></i>
                        <%= ride.preferences?.pets ? 'Pets Allowed' : 'No Pets' %>
                    </span>
                    <span class="px-3 py-1 bg-gray-100 rounded-full text-sm">
                        <i class="fas fa-suitcase mr-1"></i>
                        <%= ride.preferences?.luggage || 'Medium Luggage' %>
                    </span>
                </div>
            </div>

            <!-- Special Instructions -->
            <% if (ride.specialInstructions) { %>
                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
                    <h3 class="font-semibold text-gray-700 mb-2">
                        <i class="fas fa-info-circle text-blue-500 mr-2"></i>Special Instructions
                    </h3>
                    <p class="text-gray-700">
                        <%= ride.specialInstructions %>
                    </p>
                </div>
                <% } %>

                    <!-- Carbon Impact -->
                    <% if (ride.carbon && ride.carbon.carbonSaved> 0) { %>
                        <div class="bg-green-50 border-l-4 border-green-500 p-4 mb-6">
                            <h3 class="font-semibold text-gray-700 mb-2">
                                <i class="fas fa-leaf text-green-500 mr-2"></i>Environmental Impact
                            </h3>
                            <p class="text-gray-700">
                                Save <span class="font-bold text-green-600">
                                    <%= ride.carbon.carbonSaved.toFixed(2) %> kg CO₂
                                </span>
                                by carpooling. Equivalent to planting <%= ride.carbon.equivalentTrees %> trees!
                            </p>
                        </div>
                        <% } %>

                            <!-- Booking Section (For Passengers) -->
                            <% if (ride.rider._id.toString() !==user._id.toString() && ride.status==='ACTIVE' &&
                                ride.pricing.availableSeats> 0) { %>
                                <div class="border-t pt-6 mb-6">
                                    <h3 class="font-semibold text-gray-700 mb-4">
                                        <i class="fas fa-ticket-alt text-primary mr-2"></i>Book This Ride
                                    </h3>

                                    <% if (userBooking) { %>
                                        <!-- User already has a booking -->
                                        <div class="bg-blue-50 border-l-4 border-blue-500 p-4">
                                            <p class="text-blue-800 font-medium">
                                                You have already booked this ride.
                                                <a href="/bookings/<%= userBooking._id %>"
                                                    class="underline hover:text-blue-900">View Booking</a>
                                            </p>
                                        </div>
                                        <% } else { %>
                                            <!-- Booking Form -->
                                            <form id="bookingForm" class="space-y-4">
                                                <input type="hidden" name="rideId" value="<%= ride._id %>">

                                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                    <!-- Pickup Location -->
                                                    <div>
                                                        <label class="block text-gray-700 font-medium mb-2">
                                                            <i
                                                                class="fas fa-map-marker-alt text-green-600 mr-1"></i>Your
                                                            Pickup Point
                                                        </label>
                                                        <input type="text" id="pickupLocation" name="pickupLocation"
                                                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary"
                                                            placeholder="Enter your pickup location" required>
                                                        <input type="hidden" id="pickupCoords" name="pickupCoords">
                                                    </div>

                                                    <!-- Dropoff Location -->
                                                    <div>
                                                        <label class="block text-gray-700 font-medium mb-2">
                                                            <i class="fas fa-map-marker-alt text-red-600 mr-1"></i>Your
                                                            Dropoff Point
                                                        </label>
                                                        <input type="text" id="dropoffLocation" name="dropoffLocation"
                                                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary"
                                                            placeholder="Enter your dropoff location" required>
                                                        <input type="hidden" id="dropoffCoords" name="dropoffCoords">
                                                    </div>
                                                </div>

                                                <!-- Number of Seats -->
                                                <div>
                                                    <label class="block text-gray-700 font-medium mb-2">
                                                        <i class="fas fa-users text-primary mr-1"></i>Number of Seats
                                                    </label>
                                                    <select name="seats" id="seatsSelect"
                                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                                                        <% for(let i=1; i <=Math.min(ride.pricing.availableSeats, 4);
                                                            i++) { %>
                                                            <option value="<%= i %>">
                                                                <%= i %> Seat<%= i> 1 ? 's' : '' %>
                                                            </option>
                                                            <% } %>
                                                    </select>
                                                </div>

                                                <!-- Special Requests -->
                                                <div>
                                                    <label class="block text-gray-700 font-medium mb-2">
                                                        <i class="fas fa-comment text-primary mr-1"></i>Special Requests
                                                        (Optional)
                                                    </label>
                                                    <textarea name="specialRequests" rows="3"
                                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary"
                                                        placeholder="Any special requests or notes for the rider..."></textarea>
                                                </div>

                                                <!-- Price Summary -->
                                                <div class="bg-gray-50 rounded-lg p-4">
                                                    <div class="flex justify-between mb-2">
                                                        <span>Price per seat:</span>
                                                        <span class="font-semibold">₹<%= ride.pricing.pricePerSeat %>
                                                        </span>
                                                    </div>
                                                    <div class="flex justify-between mb-2">
                                                        <span>Seats:</span>
                                                        <span id="seatsCount" class="font-semibold">1</span>
                                                    </div>
                                                    <div
                                                        class="border-t pt-2 mt-2 flex justify-between text-lg font-bold">
                                                        <span>Total Amount:</span>
                                                        <span id="totalPrice" class="text-primary">₹<%=
                                                                ride.pricing.pricePerSeat %></span>
                                                    </div>
                                                    <p class="text-xs text-gray-500 mt-2 text-center">
                                                        <i class="fas fa-info-circle mr-1"></i>Pay directly to rider
                                                        (10% platform fee deducted from rider's earnings)
                                                    </p>
                                                </div>

                                                <!-- Payment Method -->
                                                <div>
                                                    <label class="block text-gray-700 font-medium mb-2">
                                                        <i class="fas fa-credit-card text-primary mr-1"></i>Payment
                                                        Method
                                                    </label>
                                                    <select name="paymentMethod"
                                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                                                        <option value="CASH">Cash (Pay to rider)</option>
                                                        <option value="UPI">UPI</option>
                                                        <option value="CARD">Card</option>
                                                    </select>
                                                </div>

                                                <!-- Submit Button -->
                                                <button type="submit"
                                                    class="w-full bg-primary hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold transition transform hover:scale-105">
                                                    <i class="fas fa-check-circle mr-2"></i>Request Booking
                                                </button>
                                            </form>
                                            <% } %>
                                </div>
                                <% } %>

                                    <!-- Driver Info (For Passengers viewing ride) -->
                                    <% if (ride.rider._id.toString() !==user._id.toString()) { %>
                                        <div class="border-t pt-6 mb-6">
                                            <h3 class="font-semibold text-gray-700 mb-4">
                                                <i class="fas fa-user text-primary mr-2"></i>About Your Driver
                                            </h3>
                                            <div class="flex items-start space-x-4">
                                                <img src="<%= ride.rider.profilePhoto || '/images/default-avatar.png' %>"
                                                    alt="<%= getUserName(ride.rider) %>" class="w-20 h-20 rounded-full">
                                                <div class="flex-1">
                                                    <h4 class="text-lg font-semibold">
                                                        <%= getUserName(ride.rider) %>
                                                    </h4>
                                                    <div class="flex items-center text-yellow-500 mb-2">
                                                        <% const riderRating=ride.rider.rating?.overall || 0; %>
                                                            <% for(let i=0; i < 5; i++) { %>
                                                                <i
                                                                    class="fas fa-star <%= i < Math.floor(riderRating) ? '' : 'text-gray-300' %>"></i>
                                                                <% } %>
                                                                    <span class="text-gray-600 ml-2">
                                                                        <%= riderRating.toFixed(1) %> (<%=
                                                                                ride.rider.rating?.count || 0 %>
                                                                                reviews)
                                                                    </span>
                                                    </div>
                                                    <% if (ride.rider.bio) { %>
                                                        <p class="text-gray-600 text-sm">
                                                            <%= ride.rider.bio %>
                                                        </p>
                                                        <% } %>
                                                            <div class="flex gap-4 mt-3 text-sm text-gray-600">
                                                                <span><i class="fas fa-car mr-1"></i>
                                                                    <%= ride.rider.statistics?.totalRidesCompleted || 0
                                                                        %> rides
                                                                </span>
                                                                <span><i class="fas fa-road mr-1"></i>
                                                                    <%= (ride.rider.statistics?.totalDistanceTraveled ||
                                                                        0).toFixed(0) %> km
                                                                </span>
                                                                <span><i class="fas fa-calendar mr-1"></i>Member since
                                                                    <%= new Date(ride.rider.createdAt).getFullYear() %>
                                                                </span>
                                                            </div>
                                                </div>
                                            </div>
                                        </div>
                                        <% } %>

                                            <!-- Pending Booking Requests (For Rider viewing their ride) -->
                                            <% if (ride.rider._id.toString()===user._id.toString()) { %>
                                                <% const pendingBookings=(ride.bookings || []).filter(b=> b.status ===
                                                    'PENDING');
                                                    %>
                                                    <!-- Booking Statistics Card -->
                                                    <% if (ride.bookings && ride.bookings.length> 0) { %>
                                                        <div class="border-t pt-6 mb-6">
                                                            <h3 class="font-semibold text-gray-700 mb-4">
                                                                <i
                                                                    class="fas fa-chart-line text-primary mr-2"></i>Booking
                                                                Overview
                                                            </h3>
                                                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                                                <div
                                                                    class="bg-yellow-50 border-l-4 border-yellow-500 rounded-lg p-4">
                                                                    <div class="flex items-center justify-between">
                                                                        <div>
                                                                            <p
                                                                                class="text-yellow-700 text-sm font-medium">
                                                                                Pending</p>
                                                                            <p
                                                                                class="text-2xl font-bold text-yellow-900">
                                                                                <%= bookingStats.totalPending %>
                                                                            </p>
                                                                        </div>
                                                                        <i
                                                                            class="fas fa-clock text-3xl text-yellow-400"></i>
                                                                    </div>
                                                                </div>
                                                                <div
                                                                    class="bg-green-50 border-l-4 border-green-500 rounded-lg p-4">
                                                                    <div class="flex items-center justify-between">
                                                                        <div>
                                                                            <p
                                                                                class="text-green-700 text-sm font-medium">
                                                                                Confirmed</p>
                                                                            <p
                                                                                class="text-2xl font-bold text-green-900">
                                                                                <%= bookingStats.totalConfirmed %>
                                                                            </p>
                                                                        </div>
                                                                        <i
                                                                            class="fas fa-check-circle text-3xl text-green-400"></i>
                                                                    </div>
                                                                </div>
                                                                <div
                                                                    class="bg-blue-50 border-l-4 border-blue-500 rounded-lg p-4">
                                                                    <div class="flex items-center justify-between">
                                                                        <div>
                                                                            <p
                                                                                class="text-blue-700 text-sm font-medium">
                                                                                Seats Booked</p>
                                                                            <p class="text-2xl font-bold text-blue-900">
                                                                                <%= bookingStats.seatsBooked %>
                                                                            </p>
                                                                        </div>
                                                                        <i
                                                                            class="fas fa-users text-3xl text-blue-400"></i>
                                                                    </div>
                                                                </div>
                                                                <div
                                                                    class="bg-purple-50 border-l-4 border-purple-500 rounded-lg p-4">
                                                                    <div class="flex items-center justify-between">
                                                                        <div>
                                                                            <p
                                                                                class="text-purple-700 text-sm font-medium">
                                                                                Revenue</p>
                                                                            <p
                                                                                class="text-2xl font-bold text-purple-900">
                                                                                ₹<%= bookingStats.totalRevenue.toFixed(0)
                                                                                    %>
                                                                            </p>
                                                                        </div>
                                                                        <i
                                                                            class="fas fa-rupee-sign text-3xl text-purple-400"></i>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <% } %>

                                                            <!-- Pending Requests Section -->
                                                            <% if (pendingBookings.length> 0) { %>
                                                                <div class="border-t pt-6 mb-6"
                                                                    id="pendingRequestsSection">
                                                                    <div class="flex items-center justify-between mb-4">
                                                                        <h3 class="font-semibold text-gray-700">
                                                                            <i
                                                                                class="fas fa-clock text-yellow-500 mr-2"></i>Pending
                                                                            Booking Requests (<%= pendingBookings.length
                                                                                %>)
                                                                        </h3>
                                                                        <button onclick="acceptAllBookings()"
                                                                            class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm">
                                                                            <i
                                                                                class="fas fa-check-double mr-2"></i>Accept
                                                                            All
                                                                        </button>
                                                                    </div>
                                                                    <div class="space-y-4" id="pendingBookingsList">
                                                                        <% pendingBookings.forEach(booking=> { %>
                                                                            <div class="bg-white border-2 border-yellow-400 rounded-xl p-6 shadow-lg hover:shadow-xl transition"
                                                                                id="booking-<%= booking._id %>">
                                                                                <div
                                                                                    class="flex flex-col lg:flex-row gap-6">
                                                                                    <!-- Passenger Info Column -->
                                                                                    <div
                                                                                        class="flex-shrink-0 text-center lg:text-left">
                                                                                        <img src="<%= booking.passenger?.profilePhoto || booking.passenger?.profile?.photo || '/images/default-avatar.png' %>"
                                                                                                                                    alt="<%= getUserName(booking.passenger) %>"
                                                                                            class="w-24 h-24 rounded-full mx-auto lg:mx-0 border-4 border-yellow-400 shadow-lg">
                                                                                        <h4
                                                                                            class="font-bold text-lg mt-3">
                                                                                            <%= getUserName(booking.passenger)
                                                                                                %>
                                                                                        </h4>

                                                                                        <% if
                                                                                            (booking.passenger?.rating?.overall)
                                                                                            { %>
                                                                                            <div
                                                                                                class="flex items-center justify-center lg:justify-start mt-2">
                                                                                                <div
                                                                                                    class="flex text-yellow-500">
                                                                                                    <% for(let i=0; i <
                                                                                                        5; i++) { %>
                                                                                                        <i
                                                                                                            class="fas fa-star <%= i < Math.floor(booking.passenger.rating.overall) ? '' : 'text-gray-300' %>"></i>
                                                                                                        <% } %>
                                                                                                </div>
                                                                                                <span
                                                                                                    class="ml-2 text-sm text-gray-600">
                                                                                                    <%= booking.passenger.rating.overall.toFixed(1)
                                                                                                        %>
                                                                                                        (<%= booking.passenger.rating.count
                                                                                                            %> reviews)
                                                                                                </span>
                                                                                            </div>
                                                                                            <% } %>

                                                                                                <!-- Verification Badges -->
                                                                                                <div
                                                                                                    class="flex flex-wrap gap-1 justify-center lg:justify-start mt-3">
                                                                                                    <% if
                                                                                                        (booking.passenger?.verificationStatus==='VERIFIED'
                                                                                                        ) { %>
                                                                                                        <span
                                                                                                            class="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-full">
                                                                                                            <i
                                                                                                                class="fas fa-check-circle"></i>
                                                                                                            Verified
                                                                                                        </span>
                                                                                                        <% } %>
                                                                                                            <% if
                                                                                                                (booking.passenger?.statistics?.totalRidesCompleted>
                                                                                                                10) { %>
                                                                                                                <span
                                                                                                                    class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full">
                                                                                                                    <i
                                                                                                                        class="fas fa-award"></i>
                                                                                                                    Experienced
                                                                                                                </span>
                                                                                                                <% } %>
                                                                                                                    <% if
                                                                                                                        (booking.passenger?.statistics?.totalRidesCompleted>
                                                                                                                        50)
                                                                                                                        {
                                                                                                                        %>
                                                                                                                        <span
                                                                                                                            class="px-2 py-1 bg-purple-100 text-purple-700 text-xs rounded-full">
                                                                                                                            <i
                                                                                                                                class="fas fa-crown"></i>
                                                                                                                            Elite
                                                                                                                        </span>
                                                                                                                        <% }
                                                                                                                            %>
                                                                                                </div>

                                                                                                <!-- Passenger Stats -->
                                                                                                <div
                                                                                                    class="mt-4 text-xs text-gray-600 space-y-1">
                                                                                                    <div><i
                                                                                                            class="fas fa-car mr-1 text-primary"></i>
                                                                                                        <%= booking.passenger?.statistics?.totalRidesCompleted
                                                                                                            || 0 %>
                                                                                                            rides
                                                                                                    </div>
                                                                                                    <div><i
                                                                                                            class="fas fa-calendar mr-1 text-primary"></i>
                                                                                                        Member since <%=
                                                                                                            new
                                                                                                            Date(booking.passenger?.createdAt).toLocaleDateString('en-US',
                                                                                                            {month: 'short'
                                                                                                            ,
                                                                                                            year: 'numeric'
                                                                                                            }) %>
                                                                                                    </div>
                                                                                                </div>
                                                                                    </div>

                                                                                    <!-- Booking Details Column -->
                                                                                    <div class="flex-1">
                                                                                        <div
                                                                                            class="bg-yellow-50 rounded-lg p-4 mb-4">
                                                                                            <div
                                                                                                class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                                                                <div>
                                                                                                    <p
                                                                                                        class="text-xs text-gray-500 mb-1">
                                                                                                        SEATS REQUESTED
                                                                                                    </p>
                                                                                                    <p
                                                                                                        class="text-xl font-bold text-gray-800">
                                                                                                        <i
                                                                                                            class="fas fa-users text-primary mr-2"></i>
                                                                                                        <%= booking.seatsBooked
                                                                                                            || 1 %>
                                                                                                    </p>
                                                                                                </div>
                                                                                                <div>
                                                                                                    <p
                                                                                                        class="text-xs text-gray-500 mb-1">
                                                                                                        TOTAL AMOUNT</p>
                                                                                                    <p
                                                                                                        class="text-xl font-bold text-gray-800">
                                                                                                        <i
                                                                                                            class="fas fa-rupee-sign text-primary mr-2"></i>
                                                                                                        <%= booking.totalPrice?.toFixed(2)
                                                                                                            || 0 %>
                                                                                                    </p>
                                                                                                </div>
                                                                                                <div>
                                                                                                    <p
                                                                                                        class="text-xs text-gray-500 mb-1">
                                                                                                        PAYMENT METHOD
                                                                                                    </p>
                                                                                                    <p
                                                                                                        class="text-sm font-semibold text-gray-700">
                                                                                                        <i
                                                                                                            class="fas fa-wallet text-primary mr-2"></i>
                                                                                                        <%= booking.payment?.method
                                                                                                            || 'CASH' %>
                                                                                                    </p>
                                                                                                </div>
                                                                                                <div>
                                                                                                    <p
                                                                                                        class="text-xs text-gray-500 mb-1">
                                                                                                        REQUESTED</p>
                                                                                                    <p
                                                                                                        class="text-sm font-semibold text-gray-700">
                                                                                                        <i
                                                                                                            class="fas fa-clock text-primary mr-2"></i>
                                                                                                        <%= new
                                                                                                            Date(booking.createdAt).toLocaleString('en-US',
                                                                                                            {month: 'short'
                                                                                                            ,
                                                                                                            day: 'numeric'
                                                                                                            ,
                                                                                                            hour: '2-digit'
                                                                                                            ,
                                                                                                            minute: '2-digit'
                                                                                                            }) %>
                                                                                                    </p>
                                                                                                </div>
                                                                                            </div>
                                                                                        </div>

                                                                                        <!-- Route Details -->
                                                                                        <div class="space-y-3 mb-4">
                                                                                            <div
                                                                                                class="flex items-start">
                                                                                                <div
                                                                                                    class="flex-shrink-0 w-8 h-8 bg-green-500 rounded-full flex items-center justify-center">
                                                                                                    <i
                                                                                                        class="fas fa-map-marker-alt text-white text-sm"></i>
                                                                                                </div>
                                                                                                <div
                                                                                                    class="ml-3 flex-1">
                                                                                                    <p
                                                                                                        class="text-xs text-gray-500">
                                                                                                        PICKUP LOCATION
                                                                                                    </p>
                                                                                                    <p
                                                                                                        class="text-sm font-semibold text-gray-800">
                                                                                                        <%= booking.pickupLocation?.address
                                                                                                            ||
                                                                                                            booking.pickupPoint?.address
                                                                                                            || 'Same as ride start'
                                                                                                            %>
                                                                                                    </p>
                                                                                                </div>
                                                                                            </div>
                                                                                            <div
                                                                                                class="ml-4 border-l-2 border-gray-300 h-6">
                                                                                            </div>
                                                                                            <div
                                                                                                class="flex items-start">
                                                                                                <div
                                                                                                    class="flex-shrink-0 w-8 h-8 bg-red-500 rounded-full flex items-center justify-center">
                                                                                                    <i
                                                                                                        class="fas fa-map-marker-alt text-white text-sm"></i>
                                                                                                </div>
                                                                                                <div
                                                                                                    class="ml-3 flex-1">
                                                                                                    <p
                                                                                                        class="text-xs text-gray-500">
                                                                                                        DROPOFF LOCATION
                                                                                                    </p>
                                                                                                    <p
                                                                                                        class="text-sm font-semibold text-gray-800">
                                                                                                        <%= booking.dropoffLocation?.address
                                                                                                            ||
                                                                                                            booking.dropoffPoint?.address
                                                                                                            || 'Same as ride destination'
                                                                                                            %>
                                                                                                    </p>
                                                                                                </div>
                                                                                            </div>
                                                                                        </div>

                                                                                        <!-- Special Requests -->
                                                                                        <% if (booking.specialRequests)
                                                                                            { %>
                                                                                            <div
                                                                                                class="bg-blue-50 rounded-lg p-3 mb-4">
                                                                                                <p
                                                                                                    class="text-xs text-blue-700 font-semibold mb-1">
                                                                                                    <i
                                                                                                        class="fas fa-comment-dots mr-1"></i>SPECIAL
                                                                                                    REQUESTS
                                                                                                </p>
                                                                                                <p
                                                                                                    class="text-sm text-gray-700">
                                                                                                    <%= booking.specialRequests
                                                                                                        %>
                                                                                                </p>
                                                                                            </div>
                                                                                            <% } %>

                                                                                                <!-- Co-Passengers -->
                                                                                                <% if
                                                                                                    (booking.coPassengers
                                                                                                    &&
                                                                                                    booking.coPassengers.length>
                                                                                                    0) { %>
                                                                                                    <div
                                                                                                        class="bg-purple-50 rounded-lg p-3 mb-4">
                                                                                                        <p
                                                                                                            class="text-xs text-purple-700 font-semibold mb-2">
                                                                                                            <i
                                                                                                                class="fas fa-user-friends mr-1"></i>CO-PASSENGERS
                                                                                                            (<%= booking.coPassengers.length
                                                                                                                %>)
                                                                                                        </p>
                                                                                                        <div
                                                                                                            class="space-y-1">
                                                                                                            <%
                                                                                                                booking.coPassengers.forEach(cp=>
                                                                                                                { %>
                                                                                                                <p
                                                                                                                    class="text-sm text-gray-700">
                                                                                                                    •
                                                                                                                    <%= cp.name
                                                                                                                        %>
                                                                                                                        <% if
                                                                                                                            (cp.age)
                                                                                                                            {
                                                                                                                            %>
                                                                                                                            (Age:
                                                                                                                            <%= cp.age
                                                                                                                                %>
                                                                                                                                )
                                                                                                                                <% }
                                                                                                                                    %>
                                                                                                                                    <% if
                                                                                                                                        (cp.phone)
                                                                                                                                        {
                                                                                                                                        %>
                                                                                                                                        -
                                                                                                                                        <%= cp.phone
                                                                                                                                            %>
                                                                                                                                            <% }
                                                                                                                                                %>
                                                                                                                </p>
                                                                                                                <% });
                                                                                                                    %>
                                                                                                        </div>
                                                                                                    </div>
                                                                                                    <% } %>
                                                                                    </div>

                                                                                    <!-- Action Buttons Column -->
                                                                                    <div
                                                                                        class="flex flex-col gap-2 lg:w-40">
                                                                                        <button
                                                                                            onclick="acceptBooking('<%= booking._id %>')"
                                                                                            class="w-full px-4 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg transition text-sm font-bold shadow-md hover:shadow-lg transform hover:scale-105">
                                                                                            <i
                                                                                                class="fas fa-check mr-2"></i>Accept
                                                                                        </button>
                                                                                        <button
                                                                                            onclick="rejectBooking('<%= booking._id %>')"
                                                                                            class="w-full px-4 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg transition text-sm font-bold shadow-md hover:shadow-lg transform hover:scale-105">
                                                                                            <i
                                                                                                class="fas fa-times mr-2"></i>Reject
                                                                                        </button>
                                                                                        <a href="/bookings/<%= booking._id %>"
                                                                                            class="w-full px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition text-sm font-bold text-center shadow-md hover:shadow-lg">
                                                                                            <i
                                                                                                class="fas fa-eye mr-2"></i>Details
                                                                                        </a>
                                                                                        <a href="tel:<%= booking.passenger?.phone || '' %>"
                                                                                            class="w-full px-4 py-3 bg-gray-700 hover:bg-gray-800 text-white rounded-lg transition text-sm font-bold text-center shadow-md hover:shadow-lg">
                                                                                            <i
                                                                                                class="fas fa-phone mr-2"></i>Call
                                                                                        </a>
                                                                                        <button
                                                                                            onclick="openChat('<%= booking._id %>')"
                                                                                            class="w-full px-4 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition text-sm font-bold text-center shadow-md hover:shadow-lg">
                                                                                            <i
                                                                                                class="fas fa-comment mr-2"></i>Message
                                                                                        </button>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                            <% }); %>
                                                                    </div>
                                                                </div>
                                                                <% } %>

                                                                    <!-- Confirmed Passengers Section -->
                                                                    <% if (confirmedBookings.length> 0) { %>
                                                                        <div class="border-t pt-6"
                                                                            id="confirmedPassengersSection">
                                                                            <div
                                                                                class="flex items-center justify-between mb-4">
                                                                                <h3 class="font-semibold text-gray-700">
                                                                                    <i
                                                                                        class="fas fa-users text-green-600 mr-2"></i>Confirmed
                                                                                    Passengers (<%=
                                                                                        confirmedBookings.length %>)
                                                                                </h3>
                                                                                <button onclick="messageAllPassengers()"
                                                                                    class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm">
                                                                                    <i
                                                                                        class="fas fa-comment-alt mr-2"></i>Message
                                                                                    All
                                                                                </button>
                                                                            </div>
                                                                            <div class="space-y-4"
                                                                                id="confirmedBookingsList">
                                                                                <% confirmedBookings.forEach(booking=> {
                                                                                    %>
                                                                                    <div class="bg-white border-2 <%= booking.status === 'PICKUP_PENDING' ? 'border-blue-400' : booking.status === 'PICKED_UP' ? 'border-purple-400' : (booking.status === 'DROPPED_OFF' && booking.payment.status !== 'PAID') ? 'border-yellow-400' : (booking.status === 'DROPPED_OFF' && booking.payment.status === 'PAID') || booking.status === 'COMPLETED' ? 'border-green-400' : 'border-gray-400' %> rounded-xl p-5 shadow-md hover:shadow-lg transition"
                                                                                        id="confirmed-booking-<%= booking._id %>">
                                                                                        <div
                                                                                            class="flex flex-col md:flex-row gap-4">
                                                                                            <!-- Passenger Info -->
                                                                                            <div
                                                                                                class="flex items-center flex-1">
                                                                                                <img src="<%= booking.passenger?.profilePhoto || booking.passenger?.profile?.photo || '/images/default-avatar.png' %>"
                                                                                                    alt="<%= getUserName(booking.passenger) %>"
                                                                                                    class="w-16 h-16 rounded-full mr-4 <%= booking.status === 'PICKUP_PENDING' ? 'border-4 border-blue-400' : booking.status === 'PICKED_UP' ? 'border-4 border-purple-400' : (booking.status === 'DROPPED_OFF' && booking.payment.status !== 'PAID') ? 'border-4 border-yellow-400' : (booking.status === 'DROPPED_OFF' && booking.payment.status === 'PAID') || booking.status === 'COMPLETED' ? 'border-4 border-green-400' : 'border-4 border-gray-400' %>">
                                                                                                <div class="flex-1">
                                                                                                    <div
                                                                                                        class="flex items-center gap-2 mb-1">
                                                                                                        <h4
                                                                                                            class="font-bold text-lg">
                                                                                                            <%= getUserName(booking.passenger)
                                                                                                                %>
                                                                                                        </h4>
                                                                                                        <% if
                                                                                                            (booking.passenger?.verificationStatus==='VERIFIED'
                                                                                                            ) { %>
                                                                                                            <span
                                                                                                                class="px-2 py-0.5 bg-blue-100 text-blue-700 text-xs rounded-full">
                                                                                                                <i
                                                                                                                    class="fas fa-check-circle"></i>
                                                                                                                Verified
                                                                                                            </span>
                                                                                                            <% } %>
                                                                                                    </div>

                                                                                                    <!-- Status Badge -->
                                                                                                    <div class="mb-2">
                                                                                                        <% if
                                                                                                            (booking.status==='CONFIRMED'
                                                                                                            ) { %>
                                                                                                            <span
                                                                                                                class="px-3 py-1 bg-green-100 text-green-800 text-xs font-semibold rounded-full">
                                                                                                                <i
                                                                                                                    class="fas fa-check-circle"></i>
                                                                                                                Waiting
                                                                                                                for ride
                                                                                                                to start
                                                                                                            </span>
                                                                                                            <% } else if
                                                                                                                (booking.status==='PICKUP_PENDING'
                                                                                                                ) { %>
                                                                                                                <span
                                                                                                                    class="px-3 py-1 bg-blue-100 text-blue-800 text-xs font-semibold rounded-full animate-pulse">
                                                                                                                    <i
                                                                                                                        class="fas fa-map-marker-alt"></i>
                                                                                                                    Ready
                                                                                                                    for
                                                                                                                    pickup
                                                                                                                </span>
                                                                                                                <% } else
                                                                                                                    if
                                                                                                                    (booking.status==='PICKED_UP'
                                                                                                                    ) {
                                                                                                                    %>
                                                                                                                    <span
                                                                                                                        class="px-3 py-1 bg-purple-100 text-purple-800 text-xs font-semibold rounded-full">
                                                                                                                        <i
                                                                                                                            class="fas fa-car"></i>
                                                                                                                        On
                                                                                                                        board
                                                                                                                    </span>
                                                                                                                    <% } else
                                                                                                                        if
                                                                                                                        (booking.status==='DROPPED_OFF'
                                                                                                                        )
                                                                                                                        {
                                                                                                                        %>
                                                                                                                        <% if
                                                                                                                            (booking.payment
                                                                                                                            &&
                                                                                                                            booking.payment.status==='PAID'
                                                                                                                            )
                                                                                                                            {
                                                                                                                            %>
                                                                                                                            <span
                                                                                                                                class="px-3 py-1 bg-green-100 text-green-800 text-xs font-semibold rounded-full">
                                                                                                                                <i
                                                                                                                                    class="fas fa-check-circle"></i>
                                                                                                                                Completed
                                                                                                                            </span>
                                                                                                                            <% } else
                                                                                                                                {
                                                                                                                                %>
                                                                                                                                <span
                                                                                                                                    class="px-3 py-1 bg-yellow-100 text-yellow-800 text-xs font-semibold rounded-full">
                                                                                                                                    <i
                                                                                                                                        class="fas fa-clock"></i>
                                                                                                                                    Payment
                                                                                                                                    Pending
                                                                                                                                </span>
                                                                                                                                <% }
                                                                                                                                    %>
                                                                                                                                    <% } else
                                                                                                                                        if
                                                                                                                                        (booking.status==='COMPLETED'
                                                                                                                                        )
                                                                                                                                        {
                                                                                                                                        %>
                                                                                                                                        <span
                                                                                                                                            class="px-3 py-1 bg-green-100 text-green-800 text-xs font-semibold rounded-full">
                                                                                                                                            <i
                                                                                                                                                class="fas fa-check-double"></i>
                                                                                                                                            Completed
                                                                                                                                        </span>
                                                                                                                                        <% }
                                                                                                                                            %>
                                                                                                    </div>

                                                                                                    <% if
                                                                                                        (booking.passenger?.rating?.overall)
                                                                                                        { %>
                                                                                                        <div
                                                                                                            class="flex items-center mb-2">
                                                                                                            <div
                                                                                                                class="flex text-yellow-500 text-sm">
                                                                                                                <% for(let
                                                                                                                    i=0;
                                                                                                                    i <
                                                                                                                    5;
                                                                                                                    i++)
                                                                                                                    { %>
                                                                                                                    <i
                                                                                                                        class="fas fa-star <%= i < Math.floor(booking.passenger.rating.overall) ? '' : 'text-gray-300' %>"></i>
                                                                                                                    <% }
                                                                                                                        %>
                                                                                                            </div>
                                                                                                            <span
                                                                                                                class="ml-2 text-sm text-gray-600">
                                                                                                                <%= booking.passenger.rating.overall.toFixed(1)
                                                                                                                    %>
                                                                                                            </span>
                                                                                                        </div>
                                                                                                        <% } %>

                                                                                                            <div
                                                                                                                class="flex flex-wrap gap-3 text-xs text-gray-600">
                                                                                                                <span><i
                                                                                                                        class="fas fa-users text-primary mr-1"></i>
                                                                                                                    <%= booking.seatsBooked
                                                                                                                        ||
                                                                                                                        1
                                                                                                                        %>
                                                                                                                        seat(s)
                                                                                                                </span>
                                                                                                                <span><i
                                                                                                                        class="fas fa-rupee-sign text-primary mr-1"></i>₹
                                                                                                                    <%= booking.totalPrice?.toFixed(2)
                                                                                                                        ||
                                                                                                                        0
                                                                                                                        %>
                                                                                                                </span>
                                                                                                                <span><i
                                                                                                                        class="fas fa-car text-primary mr-1"></i>
                                                                                                                    <%= booking.passenger?.statistics?.totalRidesCompleted
                                                                                                                        ||
                                                                                                                        0
                                                                                                                        %>
                                                                                                                        rides
                                                                                                                </span>
                                                                                                            </div>
                                                                                                </div>
                                                                                            </div>

                                                                                            <!-- Booking Info & OTP Section -->
                                                                                            <div
                                                                                                class="flex-1 bg-gray-50 rounded-lg p-3">
                                                                                                <div
                                                                                                    class="space-y-2 text-sm">
                                                                                                    <div
                                                                                                        class="flex items-start">
                                                                                                        <i
                                                                                                            class="fas fa-map-marker-alt text-green-600 mt-1 mr-2"></i>
                                                                                                        <div
                                                                                                            class="flex-1">
                                                                                                            <p
                                                                                                                class="text-xs text-gray-500">
                                                                                                                Pickup
                                                                                                            </p>
                                                                                                            <p
                                                                                                                class="font-medium">
                                                                                                                <%= booking.pickupLocation?.address
                                                                                                                    ||
                                                                                                                    booking.pickupPoint?.address
                                                                                                                    || 'Same as start'
                                                                                                                    %>
                                                                                                            </p>
                                                                                                        </div>
                                                                                                    </div>
                                                                                                    <div
                                                                                                        class="flex items-start">
                                                                                                        <i
                                                                                                            class="fas fa-map-marker-alt text-red-600 mt-1 mr-2"></i>
                                                                                                        <div
                                                                                                            class="flex-1">
                                                                                                            <p
                                                                                                                class="text-xs text-gray-500">
                                                                                                                Dropoff
                                                                                                            </p>
                                                                                                            <p
                                                                                                                class="font-medium">
                                                                                                                <%= booking.dropoffLocation?.address
                                                                                                                    ||
                                                                                                                    booking.dropoffPoint?.address
                                                                                                                    || 'Same as destination'
                                                                                                                    %>
                                                                                                            </p>
                                                                                                        </div>
                                                                                                    </div>

                                                                                                    <% if
                                                                                                        (ride.status==='IN_PROGRESS'
                                                                                                        &&
                                                                                                        booking.status==='PICKUP_PENDING'
                                                                                                        ) { %>
                                                                                                        <!-- PICKUP OTP VERIFICATION -->
                                                                                                        <div
                                                                                                            class="border-t pt-3 mt-3">
                                                                                                            <div
                                                                                                                class="bg-blue-50 border-2 border-blue-400 rounded-lg p-3">
                                                                                                                <p
                                                                                                                    class="text-xs font-bold text-blue-800 mb-2 uppercase">
                                                                                                                    <i
                                                                                                                        class="fas fa-key mr-1"></i>Pickup
                                                                                                                    OTP
                                                                                                                    Required
                                                                                                                </p>
                                                                                                                <p
                                                                                                                    class="text-xs text-gray-600 mb-2">
                                                                                                                    Ask
                                                                                                                    passenger
                                                                                                                    for
                                                                                                                    their
                                                                                                                    4-digit
                                                                                                                    pickup
                                                                                                                    OTP
                                                                                                                </p>
                                                                                                                <input
                                                                                                                    type="text"
                                                                                                                    id="pickup-otp-<%= booking._id %>"
                                                                                                                    maxlength="4"
                                                                                                                    placeholder="Enter OTP"
                                                                                                                    class="w-full px-3 py-2 border-2 border-blue-300 rounded-lg text-center text-lg font-bold tracking-widest focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                                                                                    oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                                                                                                                <button
                                                                                                                    onclick="verifyPickupOTP('<%= booking._id %>')"
                                                                                                                    class="w-full mt-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold transition transform hover:scale-105">
                                                                                                                    <i
                                                                                                                        class="fas fa-check-circle mr-2"></i>Verify
                                                                                                                    &
                                                                                                                    Pick
                                                                                                                    Up
                                                                                                                </button>
                                                                                                            </div>
                                                                                                        </div>
                                                                                                        <% } else if
                                                                                                            (ride.status==='IN_PROGRESS'
                                                                                                            &&
                                                                                                            booking.status==='PICKED_UP'
                                                                                                            ) { %>
                                                                                                            <!-- DROPOFF OTP VERIFICATION -->
                                                                                                            <div
                                                                                                                class="border-t pt-3 mt-3">
                                                                                                                <div
                                                                                                                    class="bg-purple-50 border-2 border-purple-400 rounded-lg p-3">
                                                                                                                    <p
                                                                                                                        class="text-xs font-bold text-purple-800 mb-2 uppercase">
                                                                                                                        <i
                                                                                                                            class="fas fa-flag-checkered mr-1"></i>Dropoff
                                                                                                                        OTP
                                                                                                                        Required
                                                                                                                    </p>
                                                                                                                    <p
                                                                                                                        class="text-xs text-gray-600 mb-2">
                                                                                                                        Ask
                                                                                                                        passenger
                                                                                                                        for
                                                                                                                        their
                                                                                                                        4-digit
                                                                                                                        dropoff
                                                                                                                        OTP
                                                                                                                    </p>
                                                                                                                    <input
                                                                                                                        type="text"
                                                                                                                        id="dropoff-otp-<%= booking._id %>"
                                                                                                                        maxlength="4"
                                                                                                                        placeholder="Enter OTP"
                                                                                                                        class="w-full px-3 py-2 border-2 border-purple-300 rounded-lg text-center text-lg font-bold tracking-widest focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                                                                                                                        oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                                                                                                                    <button
                                                                                                                        onclick="verifyDropoffOTP('<%= booking._id %>')"
                                                                                                                        class="w-full mt-2 px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-bold transition transform hover:scale-105">
                                                                                                                        <i
                                                                                                                            class="fas fa-check-circle mr-2"></i>Verify
                                                                                                                        &
                                                                                                                        Drop
                                                                                                                        Off
                                                                                                                    </button>
                                                                                                                </div>
                                                                                                            </div>
                                                                                                            <% } %>

                                                                                                                <% if
                                                                                                                    (booking.payment?.status)
                                                                                                                    { %>
                                                                                                                    <div
                                                                                                                        class="flex items-center pt-2 border-t">
                                                                                                                        <i
                                                                                                                            class="fas fa-credit-card text-primary mr-2"></i>
                                                                                                                        <span
                                                                                                                            class="text-xs">
                                                                                                                            Payment:
                                                                                                                            <strong>
                                                                                                                                <%= booking.payment.method
                                                                                                                                    || 'CASH'
                                                                                                                                    %>
                                                                                                                            </strong>
                                                                                                                            <span
                                                                                                                                class="ml-2 px-2 py-0.5 <%= booking.payment.status === 'PAID' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700' %> rounded-full">
                                                                                                                                <%= booking.payment.status
                                                                                                                                    %>
                                                                                                                            </span>
                                                                                                                            <% if
                                                                                                                                (booking.payment.status==='PENDING'
                                                                                                                                &&
                                                                                                                                (booking.status==='PICKED_UP'
                                                                                                                                ||
                                                                                                                                booking.status==='DROPPED_OFF'
                                                                                                                                ))
                                                                                                                                {
                                                                                                                                %>
                                                                                                                                <button
                                                                                                                                    onclick="markAsPaid('<%= booking._id %>')"
                                                                                                                                    class="ml-2 px-2 py-1 bg-green-600 hover:bg-green-700 text-white text-xs rounded transition">
                                                                                                                                    <i
                                                                                                                                        class="fas fa-check-circle mr-1"></i>Mark
                                                                                                                                    Paid
                                                                                                                                </button>
                                                                                                                                <% }
                                                                                                                                    %>
                                                                                                                        </span>
                                                                                                                    </div>
                                                                                                                    <% }
                                                                                                                        %>
                                                                                                </div>
                                                                                            </div>

                                                                                            <!-- Actions -->
                                                                                            <div
                                                                                                class="flex md:flex-col gap-2">
                                                                                                <% if
                                                                                                    (booking.status==='COMPLETED'
                                                                                                    ||
                                                                                                    (booking.status==='DROPPED_OFF'
                                                                                                    && booking.payment
                                                                                                    &&
                                                                                                    booking.payment.status==='PAID'
                                                                                                    )) { %>
                                                                                                    <span
                                                                                                        class="px-4 py-2 bg-green-600 text-white text-sm rounded-lg font-semibold text-center whitespace-nowrap">
                                                                                                        <i
                                                                                                            class="fas fa-check-double mr-1"></i>Completed
                                                                                                    </span>
                                                                                                    <% } else if
                                                                                                        (booking.status==='DROPPED_OFF'
                                                                                                        ) { %>
                                                                                                        <span
                                                                                                            class="px-4 py-2 bg-yellow-600 text-white text-sm rounded-lg font-semibold text-center whitespace-nowrap">
                                                                                                            <i
                                                                                                                class="fas fa-clock mr-1"></i>Payment
                                                                                                            Pending
                                                                                                        </span>
                                                                                                        <% } else { %>
                                                                                                            <span
                                                                                                                class="px-4 py-2 bg-blue-600 text-white text-sm rounded-lg font-semibold text-center whitespace-nowrap">
                                                                                                                <i
                                                                                                                    class="fas fa-check mr-1"></i>Confirmed
                                                                                                            </span>
                                                                                                            <% } %>
                                                                                                                <a href="/bookings/<%= booking._id %>"
                                                                                                                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-semibold text-center whitespace-nowrap">
                                                                                                                    <i
                                                                                                                        class="fas fa-eye mr-1"></i>View
                                                                                                                </a>
                                                                                                                <a href="tel:<%= booking.passenger?.phone || '' %>"
                                                                                                                    class="px-4 py-2 bg-gray-700 hover:bg-gray-800 text-white rounded-lg text-sm font-semibold text-center whitespace-nowrap">
                                                                                                                    <i
                                                                                                                        class="fas fa-phone mr-1"></i>Call
                                                                                                                </a>
                                                                                                                <button
                                                                                                                    onclick="openChat('<%= booking._id %>')"
                                                                                                                    class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-semibold text-center whitespace-nowrap">
                                                                                                                    <i
                                                                                                                        class="fas fa-comment mr-1"></i>Chat
                                                                                                                </button>
                                                                                            </div>
                                                                                        </div>
                                                                                    </div>
                                                                                    <% }); %>
                                                                            </div>
                                                                        </div>
                                                                        <% } %>

                                                                            <!-- Empty State -->
                                                                            <% if (pendingBookings.length===0 &&
                                                                                confirmedBookings.length===0) { %>
                                                                                <div class="border-t pt-6">
                                                                                    <div
                                                                                        class="text-center py-8 text-gray-500">
                                                                                        <i
                                                                                            class="fas fa-users text-5xl mb-3 text-gray-300"></i>
                                                                                        <p class="text-lg">No booking
                                                                                            requests yet</p>
                                                                                        <p class="text-sm">Passengers
                                                                                            will appear here when they
                                                                                            book your ride</p>
                                                                                    </div>
                                                                                </div>
                                                                                <% } %>
                                                                                    <% } %>

                                                                                        <!-- Reviews -->
                                                                                        <% if (reviews &&
                                                                                            reviews.length> 0) { %>
                                                                                            <div
                                                                                                class="border-t pt-6 mt-6">
                                                                                                <h3
                                                                                                    class="font-semibold text-gray-700 mb-4">
                                                                                                    <i
                                                                                                        class="fas fa-comment-dots text-primary mr-2"></i>Recent
                                                                                                    Reviews
                                                                                                </h3>
                                                                                                <div class="space-y-4">
                                                                                                    <% reviews.slice(0,
                                                                                                        3).forEach(review=>
                                                                                                        { %>
                                                                                                        <div
                                                                                                            class="bg-gray-50 rounded-lg p-4">
                                                                                                            <div
                                                                                                                class="flex items-center mb-2">
                                                                                                                <img src="<%= review.reviewer?.profilePhoto || '/images/default-avatar.png' %>"
                                                                                                                    alt="<%= getUserName(review.reviewer) %>"
                                                                                                                    class="w-8 h-8 rounded-full mr-2">
                                                                                                                <div
                                                                                                                    class="flex-1">
                                                                                                                    <p
                                                                                                                        class="font-medium text-sm">
                                                                                                                        <%= getUserName(review.reviewer)
                                                                                                                            %>
                                                                                                                    </p>
                                                                                                                    <div
                                                                                                                        class="text-yellow-500 text-xs">
                                                                                                                        <% for(let
                                                                                                                            i=0;
                                                                                                                            i
                                                                                                                            <
                                                                                                                            5;
                                                                                                                            i++)
                                                                                                                            {
                                                                                                                            %>
                                                                                                                            <i
                                                                                                                                class="fas fa-star <%= i < review.rating ? '' : 'text-gray-300' %>"></i>
                                                                                                                            <% }
                                                                                                                                %>
                                                                                                                    </div>
                                                                                                                </div>
                                                                                                                <span
                                                                                                                    class="text-xs text-gray-500">
                                                                                                                    <%= new
                                                                                                                        Date(review.createdAt).toLocaleDateString()
                                                                                                                        %>
                                                                                                                </span>
                                                                                                            </div>
                                                                                                            <% if
                                                                                                                (review.comment)
                                                                                                                { %>
                                                                                                                <p
                                                                                                                    class="text-gray-600 text-sm">
                                                                                                                    <%= review.comment
                                                                                                                        %>
                                                                                                                </p>
                                                                                                                <% } %>
                                                                                                        </div>
                                                                                                        <% }); %>
                                                                                                </div>
                                                                                            </div>
                                                                                            <% } %>
        </div>
    </div>

    <script>
        // Helper function for showing alerts (fallback if LANEApp is not defined)
        function showAlert(message, type = 'info') {
            if (typeof LANEApp !== 'undefined' && LANEApp.showAlert) {
                LANEApp.showAlert(message, type);
            } else {
                // Fallback to console and alert
                console.log(`[${type.toUpperCase()}] ${message}`);
                if (type === 'error') {
                    alert(`Error: ${message}`);
                } else if (type === 'success') {
                    alert(`Success: ${message}`);
                } else {
                    console.info(message);
                }
            }
        }

        // Make it global so all functions can use it
        window.showAlert = showAlert;

        // Initialize Socket.IO for real-time updates
        const socket = io();

        // Join ride room for real-time updates
        socket.emit('join-ride', '<%= ride._id %>');

        // Listen for new booking requests
        socket.on('new-booking-request', (data) => {
            console.log('New booking request:', data);
            LANEApp.showAlert('📩 New booking request received!', 'info');
            setTimeout(() => location.reload(), 2000);
        });

        // Listen for booking status updates
        socket.on('booking-status-updated', (data) => {
            console.log('Booking status updated:', data);
            const bookingCard = document.getElementById(`booking-${data.bookingId}`) ||
                document.getElementById(`confirmed-booking-${data.bookingId}`);
            if (bookingCard) {
                LANEApp.showAlert(`Booking ${data.status}`, 'info');
                setTimeout(() => location.reload(), 1500);
            }
        });

        // Listen for ride started (for rider view) - REAL-TIME UPDATE
        socket.on('ride-status-updated', (data) => {
            console.log('✅ [Real-time] Ride status updated:', data);
            if (data.status === 'IN_PROGRESS') {
                LANEApp.showAlert('🚗 Ride started! You can now pick up passengers.', 'success');
                
                // Update UI dynamically without reload
                updateUIForRideStarted(data);
            }
        });

        function updateUIForRideStarted(data) {
            console.log('🔄 [UI Update] Updating rider view for ride started');
            
            // 1. Update ride status badge
            const statusBadge = document.querySelector('.ride-status-badge');
            if (statusBadge) {
                statusBadge.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800';
                statusBadge.innerHTML = '<i class="fas fa-car mr-1"></i> In Progress';
            }

            // 2. Hide "Start Ride" button
            const startRideBtn = document.getElementById('startRideBtn');
            if (startRideBtn) {
                startRideBtn.style.display = 'none';
            }

            // 3. Show "Complete Ride" button
            const completeRideBtn = document.getElementById('completeRideBtn');
            if (completeRideBtn) {
                completeRideBtn.style.display = 'block';
            }

            // 4. Reload confirmed bookings section to show OTP fields
            const confirmedSection = document.getElementById('confirmedBookingsSection');
            if (confirmedSection) {
                // Reload the page to show updated booking cards with OTP fields
                setTimeout(() => {
                    console.log('🔄 Reloading to show OTP fields...');
                    location.reload();
                }, 1500);
            }
            
            console.log('✅ [UI Update] Rider view updated successfully');
        }

        // Listen for pickup confirmations
        socket.on('pickup-confirmed', (data) => {
            console.log('Pickup confirmed:', data);
            const bookingCard = document.getElementById(`confirmed-booking-${data.bookingId}`);
            if (bookingCard) {
                LANEApp.showAlert(`✅ ${data.passengerName} picked up!`, 'success');
                // Update UI dynamically (already handled in verifyPickupOTP function)
            }
        });

        // Listen for dropoff confirmations
        socket.on('dropoff-confirmed', (data) => {
            console.log('Dropoff confirmed:', data);
            const bookingCard = document.getElementById(`confirmed-booking-${data.bookingId}`);
            if (bookingCard) {
                LANEApp.showAlert(`✅ ${data.passengerName} dropped off!`, 'success');
                // Update UI dynamically (already handled in verifyDropoffOTP function)
            }
        });

        // Listen for ride auto-completed
        socket.on('ride-auto-completed', (data) => {
            console.log('Ride auto-completed:', data);
            LANEApp.showAlert('🎉 All passengers dropped off! Ride completed!', 'success');
            setTimeout(() => location.reload(), 2000);
        });

        // Location Autocomplete for Booking Form
        function initLocationAutocomplete(input, coordsInput) {
            let debounceTimer;
            let suggestionsDiv = null;

            const createSuggestionsDiv = () => {
                if (!suggestionsDiv) {
                    suggestionsDiv = document.createElement('div');
                    suggestionsDiv.className = 'absolute z-50 w-full bg-white border border-gray-300 rounded-lg shadow-lg mt-1 max-h-60 overflow-y-auto hidden';
                    input.parentElement.style.position = 'relative';
                    input.parentElement.appendChild(suggestionsDiv);
                }
                return suggestionsDiv;
            };

            const fetchSuggestions = async (query) => {
                if (query.length < 3) {
                    createSuggestionsDiv().classList.add('hidden');
                    return;
                }

                try {
                    const response = await fetch(
                        `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=in&limit=5`,
                        { headers: { 'User-Agent': 'LANE-Carpool-App' } }
                    );
                    const results = await response.json();
                    displaySuggestions(results);
                } catch (error) {
                    console.error('Error fetching location suggestions:', error);
                }
            };

            const displaySuggestions = (results) => {
                const div = createSuggestionsDiv();
                if (results.length === 0) {
                    div.innerHTML = '<div class="p-3 text-gray-500 text-sm">No locations found</div>';
                    div.classList.remove('hidden');
                    return;
                }

                div.innerHTML = results.map(result => `
            <div class="suggestion-item p-3 hover:bg-gray-100 cursor-pointer border-b last:border-b-0"
                 data-lat="${result.lat}" data-lon="${result.lon}" data-display="${result.display_name}">
                <i class="fas fa-map-marker-alt text-primary mr-2"></i>
                <span class="text-sm">${result.display_name}</span>
            </div>
        `).join('');

                div.classList.remove('hidden');

                div.querySelectorAll('.suggestion-item').forEach(item => {
                    item.addEventListener('click', () => {
                        input.value = item.dataset.display;
                        coordsInput.value = JSON.stringify({
                            type: 'Point',
                            coordinates: [parseFloat(item.dataset.lon), parseFloat(item.dataset.lat)],
                            address: item.dataset.display
                        });
                        div.classList.add('hidden');
                    });
                });
            };

            input.addEventListener('input', (e) => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => fetchSuggestions(e.target.value.trim()), 300);
            });

            document.addEventListener('click', (e) => {
                if (suggestionsDiv && !input.contains(e.target) && !suggestionsDiv.contains(e.target)) {
                    suggestionsDiv.classList.add('hidden');
                }
            });
        }

        // Price calculation
        const seatsSelect = document.getElementById('seatsSelect');
        const pricePerSeat = <%= ride.pricing?.pricePerSeat || 0 %>;

        if (seatsSelect) {
            seatsSelect.addEventListener('change', (e) => {
                const seats = parseInt(e.target.value);
                const total = pricePerSeat * seats; // No platform fee for passenger

                document.getElementById('seatsCount').textContent = seats;
                document.getElementById('totalPrice').textContent = '₹' + total.toFixed(2);
            });

            // Initialize autocomplete
            const pickupInput = document.getElementById('pickupLocation');
            const dropoffInput = document.getElementById('dropoffLocation');

            if (pickupInput && dropoffInput) {
                initLocationAutocomplete(pickupInput, document.getElementById('pickupCoords'));
                initLocationAutocomplete(dropoffInput, document.getElementById('dropoffCoords'));
            }
        }

        // Booking form submission
        const bookingForm = document.getElementById('bookingForm');
        console.log('🔍 [Page Load] Booking form element:', bookingForm);
        
        if (bookingForm) {
            console.log('✅ [Page Load] Booking form found, attaching event listener');
            
            bookingForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                console.log('🔍 Booking form submitted');

                const pickupCoords = document.getElementById('pickupCoords').value;
                const dropoffCoords = document.getElementById('dropoffCoords').value;

                console.log('📍 Pickup coords:', pickupCoords);
                console.log('📍 Dropoff coords:', dropoffCoords);

                if (!pickupCoords || !dropoffCoords) {
                    LANEApp.showAlert('Please select valid pickup and dropoff locations from the dropdown', 'error');
                    return;
                }

                const formData = new FormData(e.target);
                const data = {
                    rideId: formData.get('rideId'),
                    pickupLocation: pickupCoords,
                    dropoffLocation: dropoffCoords,
                    seats: formData.get('seats'),
                    specialRequests: formData.get('specialRequests'),
                    paymentMethod: formData.get('paymentMethod')
                };

                console.log('📦 Booking data:', data);

                try {
                    console.log('🚀 Sending booking request...');
                    const response = await fetch('/bookings/create', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });

                    console.log('📡 Response status:', response.status);
                    const result = await response.json();
                    console.log('📥 Response data:', result);

                    if (result.success) {
                        if (typeof LANEApp !== 'undefined' && LANEApp.showAlert) {
                            LANEApp.showAlert(result.message || 'Booking request sent successfully!', 'success');
                        } else {
                            alert(result.message || 'Booking request sent successfully!');
                        }
                        // Redirect immediately without delay
                        window.location.href = result.redirectUrl || '/bookings/my-bookings';
                    } else {
                        if (typeof LANEApp !== 'undefined' && LANEApp.showAlert) {
                            LANEApp.showAlert(result.message || 'Failed to create booking', 'error');
                        } else {
                            alert(result.message || 'Failed to create booking');
                        }
                    }
                } catch (error) {
                    console.error('❌ Booking error:', error);
                    if (typeof LANEApp !== 'undefined' && LANEApp.showAlert) {
                        LANEApp.showAlert('Failed to create booking. Please try again.', 'error');
                    } else {
                        alert('Failed to create booking. Please try again.');
                    }
                }
            });
        } else {
            console.log('❌ [Page Load] Booking form NOT found on this page');
        }

        function cancelRide() {
            if (confirm('Are you sure you want to cancel this ride? This action cannot be undone.')) {
                fetch('/rides/<%= ride._id %>/cancel', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            LANEApp.showAlert('Ride cancelled successfully', 'success');
                            setTimeout(() => {
                                window.location.href = '/rides/my-rides';
                            }, 1500);
                        } else {
                            LANEApp.showAlert(data.message || 'Failed to cancel ride', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        LANEApp.showAlert('Failed to cancel ride', 'error');
                    });
            }
        }

        // Accept Booking Request
        async function acceptBooking(bookingId) {
            if (!confirm('Do you want to accept this booking request?')) {
                return;
            }

            try {
                console.log('Accepting booking:', bookingId);

                if (typeof LANEApp !== 'undefined' && LANEApp.showAlert) {
                    LANEApp.showAlert('Processing...', 'info');
                }

                const response = await fetch(`/bookings/${bookingId}/accept`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                console.log('Response status:', response.status);
                const result = await response.json();
                console.log('Result:', result);

                if (result.success) {
                    if (typeof LANEApp !== 'undefined' && LANEApp.showAlert) {
                        LANEApp.showAlert('✅ Booking accepted! Passenger notified.', 'success');
                    } else {
                        alert('Booking accepted successfully!');
                    }

                    // Update UI dynamically - Remove from pending section
                    const bookingCard = document.getElementById(`booking-${bookingId}`);
                    if (bookingCard) {
                        bookingCard.style.opacity = '0';
                        bookingCard.style.transform = 'scale(0.95)';
                        bookingCard.style.transition = 'all 0.3s ease';
                        
                        setTimeout(() => {
                            bookingCard.remove();

                            // Update pending count
                            const pendingList = document.getElementById('pendingBookingsList');
                            const remainingPending = pendingList ? pendingList.querySelectorAll('[id^="booking-"]').length : 0;
                            
                            console.log('✅ Remaining pending bookings:', remainingPending);
                            
                            // If no more pending bookings, remove section
                            if (remainingPending === 0) {
                                const pendingSection = document.getElementById('pendingRequestsSection');
                                if (pendingSection) {
                                    pendingSection.style.opacity = '0';
                                    setTimeout(() => pendingSection.remove(), 300);
                                }
                            } else {
                                // Update count in heading
                                const pendingHeading = document.querySelector('#pendingRequestsSection h3');
                                if (pendingHeading) {
                                    pendingHeading.innerHTML = `<i class="fas fa-clock text-yellow-500 mr-2"></i>Pending Booking Requests (${remainingPending})`;
                                }
                            }

                            // Reload after 2 seconds to show in confirmed section with proper structure
                            setTimeout(() => window.location.reload(), 2000);
                        }, 300);
                    } else {
                        // If card not found, just reload
                        window.location.reload();
                    }
                } else {
                    if (typeof LANEApp !== 'undefined' && LANEApp.showAlert) {
                        LANEApp.showAlert(result.message || 'Failed to accept booking', 'error');
                    } else {
                        alert(result.message || 'Failed to accept booking');
                    }
                }
            } catch (error) {
                console.error('Accept booking error:', error);
                if (typeof LANEApp !== 'undefined' && LANEApp.showAlert) {
                    LANEApp.showAlert('Failed to accept booking. Please try again.', 'error');
                } else {
                    alert('Failed to accept booking. Please try again.');
                }
            }
        }

        // Reject Booking Request
        async function rejectBooking(bookingId) {
            const reason = prompt('Please provide a reason for rejecting this booking (optional):');
            if (reason === null) {
                return; // User cancelled
            }

            try {
                LANEApp.showAlert('Processing...', 'info');

                const response = await fetch(`/bookings/${bookingId}/reject`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ reason: reason || 'No reason provided' })
                });

                const result = await response.json();

                if (result.success) {
                    LANEApp.showAlert('Booking rejected', 'success');

                    // Remove booking card
                    const bookingCard = document.getElementById(`booking-${bookingId}`);
                    if (bookingCard) {
                        bookingCard.remove();

                        // Update counts
                        const pendingCount = document.querySelectorAll('#pendingBookingsList > div').length;
                        if (pendingCount === 0) {
                            const pendingSection = document.getElementById('pendingRequestsSection');
                            if (pendingSection) {
                                pendingSection.innerHTML = `
                            <div class="text-center py-8 text-gray-500">
                                <i class="fas fa-users text-5xl mb-3 text-gray-300"></i>
                                <p class="text-lg">No pending booking requests</p>
                            </div>
                        `;
                            }
                        }
                    }

                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    LANEApp.showAlert(result.message || 'Failed to reject booking', 'error');
                }
            } catch (error) {
                console.error('Reject booking error:', error);
                LANEApp.showAlert('Failed to reject booking. Please try again.', 'error');
            }
        }

        // Accept All Pending Bookings
        async function acceptAllBookings() {
            const pendingCards = document.querySelectorAll('#pendingBookingsList > div');
            if (pendingCards.length === 0) {
                LANEApp.showAlert('No pending bookings to accept', 'info');
                return;
            }

            if (!confirm(`Accept all ${pendingCards.length} pending booking request(s)?`)) {
                return;
            }

            LANEApp.showAlert(`Accepting ${pendingCards.length} bookings...`, 'info');

            let successCount = 0;
            let failCount = 0;

            for (const card of pendingCards) {
                const bookingId = card.id.replace('booking-', '');
                try {
                    const response = await fetch(`/bookings/${bookingId}/accept`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    const result = await response.json();
                    if (result.success) {
                        successCount++;
                    } else {
                        failCount++;
                    }
                } catch (error) {
                    failCount++;
                }
            }

            if (successCount > 0) {
                LANEApp.showAlert(`✅ Accepted ${successCount} booking(s)${failCount > 0 ? `, ${failCount} failed` : ''}`, 'success');
                setTimeout(() => window.location.reload(), 2000);
            } else {
                LANEApp.showAlert('Failed to accept bookings', 'error');
            }
        }

        // Open chat for a booking
        async function openChat(bookingId) {
            try {
                console.log('🔵 Opening chat for booking:', bookingId);
                if (typeof LANEApp !== 'undefined' && LANEApp.showAlert) {
                    LANEApp.showAlert('Opening chat...', 'info');
                }

                // Get or create chat for this booking
                console.log('🔵 Making request to:', `/chat/api/booking/${bookingId}`);
                const response = await fetch(`/chat/api/booking/${bookingId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                });

                console.log('🔵 Response status:', response.status);
                console.log('🔵 Response ok:', response.ok);

                const result = await response.json();
                console.log('🔵 Response data:', result);

                if (result.success && result.chat) {
                    console.log('✅ Chat created/found:', result.chat._id);
                    console.log('🔵 Redirecting to:', `/chat/${result.chat._id}`);
                    // Redirect to chat
                    window.location.href = `/chat/${result.chat._id}`;
                } else {
                    console.error('❌ Chat creation failed:', result);
                    if (typeof LANEApp !== 'undefined' && LANEApp.showAlert) {
                        LANEApp.showAlert(result.message || 'Failed to open chat', 'error');
                    } else {
                        alert(result.message || 'Failed to open chat');
                    }
                }
            } catch (error) {
                console.error('❌ Open chat error:', error);
                if (typeof LANEApp !== 'undefined' && LANEApp.showAlert) {
                    LANEApp.showAlert(`Failed to open chat: ${error.message}`, 'error');
                } else {
                    alert(`Failed to open chat: ${error.message}`);
                }
            }
        }

        // Message All Confirmed Passengers
        function messageAllPassengers() {
            const firstBookingLink = document.querySelector('#confirmedBookingsList button[onclick*="openChat"]');

            if (!firstBookingLink) {
                if (typeof LANEApp !== 'undefined' && LANEApp.showAlert) {
                    LANEApp.showAlert('No confirmed passengers yet', 'info');
                } else {
                    alert('No confirmed passengers yet');
                }
                return;
            }

            // Click the first booking's chat button
            firstBookingLink.click();
        }

        // Start Ride
        async function startRide() {
            if (!confirm('Start the ride now? All confirmed passengers will be notified and you can begin pickups.')) {
                return;
            }

            try {
                if (typeof LANEApp !== 'undefined' && LANEApp.showAlert) {
                    LANEApp.showAlert('Starting ride...', 'info');
                }

                const response = await fetch('/rides/<%= ride._id %>/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    LANEApp.showAlert('🚗 Ride started! Passengers have received their OTPs.', 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    LANEApp.showAlert(result.message || 'Failed to start ride', 'error');
                }
            } catch (error) {
                console.error('Start ride error:', error);
                LANEApp.showAlert('Failed to start ride. Please try again.', 'error');
            }
        }

        // Verify Pickup OTP
        async function verifyPickupOTP(bookingId) {
            console.log('🔑 Verify Pickup OTP called for booking:', bookingId);

            const otpInput = document.getElementById(`pickup-otp-${bookingId}`);
            if (!otpInput) {
                console.error('❌ OTP input not found for booking:', bookingId);
                alert('Error: OTP input field not found');
                return;
            }

            const otp = otpInput.value.trim();
            console.log('OTP value:', otp);

            if (otp.length !== 4) {
                if (window.LANEApp && window.LANEApp.showAlert) {
                    LANEApp.showAlert('Please enter a valid 4-digit OTP', 'error');
                } else {
                    alert('Please enter a valid 4-digit OTP');
                }
                otpInput.focus();
                return;
            }

            try {
                if (window.LANEApp && window.LANEApp.showAlert) {
                    LANEApp.showAlert('Verifying OTP...', 'info');
                }
                console.log('📡 Sending OTP verification request...');

                const response = await fetch(`/bookings/${bookingId}/verify-pickup`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ otp })
                });

                const result = await response.json();
                console.log('📥 Response received:', result);

                if (result.success) {
                    console.log('✅ Pickup verified successfully');
                    if (window.LANEApp && window.LANEApp.showAlert) {
                        LANEApp.showAlert('✅ Pickup verified! Passenger is on board.', 'success');
                    } else {
                        alert('✅ Pickup verified! Passenger is on board.');
                    }

                    // Update UI
                    const bookingCard = document.getElementById(`confirmed-booking-${bookingId}`);
                    if (bookingCard) {
                        // Change border color
                        bookingCard.className = bookingCard.className.replace('border-blue-400', 'border-purple-400');

                        // Update status badge
                        const statusBadge = bookingCard.querySelector('.animate-pulse');
                        if (statusBadge) {
                            statusBadge.className = 'px-3 py-1 bg-purple-100 text-purple-800 text-xs font-semibold rounded-full';
                            statusBadge.innerHTML = '<i class="fas fa-car"></i> On board';
                        }

                        // Replace OTP section with dropoff OTP input
                        const otpSection = bookingCard.querySelector('.bg-blue-50');
                        if (otpSection && otpSection.parentElement) {
                            otpSection.parentElement.innerHTML = `
                        <div class="bg-purple-50 border-2 border-purple-400 rounded-lg p-3">
                            <p class="text-xs font-bold text-purple-800 mb-2 uppercase">
                                <i class="fas fa-flag-checkered mr-1"></i>Dropoff OTP Required
                            </p>
                            <p class="text-xs text-gray-600 mb-2">Ask passenger for their 4-digit dropoff OTP</p>
                            <input type="text" 
                                   id="dropoff-otp-${bookingId}"
                                   maxlength="4"
                                   placeholder="Enter OTP"
                                   class="w-full px-3 py-2 border-2 border-purple-300 rounded-lg text-center text-lg font-bold tracking-widest focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                                   oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                            <button onclick="verifyDropoffOTP('${bookingId}')" 
                                    class="w-full mt-2 px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-bold transition transform hover:scale-105">
                                <i class="fas fa-check-circle mr-2"></i>Verify & Drop Off
                            </button>
                        </div>
                    `;
                        }
                    }
                } else {
                    console.error('❌ Verification failed:', result.message);
                    if (window.LANEApp && window.LANEApp.showAlert) {
                        LANEApp.showAlert(result.message || '❌ Invalid OTP. Please try again.', 'error');
                    } else {
                        alert(result.message || '❌ Invalid OTP. Please try again.');
                    }
                    otpInput.value = '';
                    otpInput.focus();
                }
            } catch (error) {
                console.error('❌ Verify pickup OTP error:', error);
                if (window.LANEApp && window.LANEApp.showAlert) {
                    LANEApp.showAlert('Failed to verify OTP. Please try again.', 'error');
                } else {
                    alert('Failed to verify OTP. Please try again.');
                }
            }
        }

        // Verify Dropoff OTP
        async function verifyDropoffOTP(bookingId) {
            console.log('🏁 Verify Dropoff OTP called for booking:', bookingId);

            const otpInput = document.getElementById(`dropoff-otp-${bookingId}`);
            if (!otpInput) {
                console.error('❌ Dropoff OTP input not found for booking:', bookingId);
                alert('Error: Dropoff OTP input field not found');
                return;
            }

            const otp = otpInput.value.trim();
            console.log('Dropoff OTP value:', otp);

            if (otp.length !== 4) {
                if (window.LANEApp && window.LANEApp.showAlert) {
                    LANEApp.showAlert('Please enter a valid 4-digit OTP', 'error');
                } else {
                    alert('Please enter a valid 4-digit OTP');
                }
                otpInput.focus();
                return;
            }

            try {
                if (window.LANEApp && window.LANEApp.showAlert) {
                    LANEApp.showAlert('Verifying OTP...', 'info');
                }
                console.log('📡 Sending dropoff OTP verification request...');

                const response = await fetch(`/bookings/${bookingId}/verify-dropoff`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ otp })
                });

                const result = await response.json();
                console.log('📥 Dropoff response received:', result);

                if (result.success) {
                    console.log('✅ Dropoff verified successfully');
                    if (window.LANEApp && window.LANEApp.showAlert) {
                        LANEApp.showAlert('✅ Dropoff verified! Passenger has been dropped off.', 'success');
                    } else {
                        alert('✅ Dropoff verified! Passenger has been dropped off.');
                    }

                    // Update UI
                    const bookingCard = document.getElementById(`confirmed-booking-${bookingId}`);
                    if (bookingCard) {
                        // Get payment status from result
                        const paymentStatus = result.booking?.payment?.status || 'PENDING';
                        const isPaymentPaid = paymentStatus === 'PAID';

                        // Change border color based on payment status
                        if (isPaymentPaid) {
                            bookingCard.className = bookingCard.className.replace('border-purple-400', 'border-green-400');
                        } else {
                            bookingCard.className = bookingCard.className.replace('border-purple-400', 'border-yellow-400');
                        }

                        // Update status badge based on payment status
                        const statusBadge = bookingCard.querySelector('.bg-purple-100');
                        if (statusBadge) {
                            if (isPaymentPaid) {
                                statusBadge.className = 'px-3 py-1 bg-green-100 text-green-800 text-xs font-semibold rounded-full';
                                statusBadge.innerHTML = '<i class="fas fa-check-circle"></i> Completed';
                            } else {
                                statusBadge.className = 'px-3 py-1 bg-yellow-100 text-yellow-800 text-xs font-semibold rounded-full';
                                statusBadge.innerHTML = '<i class="fas fa-clock"></i> Payment Pending';
                            }
                        }

                        // Remove OTP section
                        const otpSection = bookingCard.querySelector('.bg-purple-50');
                        if (otpSection && otpSection.parentElement) {
                            otpSection.parentElement.remove();
                        }

                        // Update action button based on payment status
                        const actionButtons = bookingCard.querySelector('.md\\:flex-col');
                        if (actionButtons) {
                            const confirmBtn = actionButtons.querySelector('span');
                            if (confirmBtn) {
                                if (isPaymentPaid) {
                                    confirmBtn.className = 'px-4 py-2 bg-green-600 text-white text-sm rounded-lg font-semibold text-center whitespace-nowrap';
                                    confirmBtn.innerHTML = '<i class="fas fa-check-double mr-1"></i>Completed';
                                } else {
                                    confirmBtn.className = 'px-4 py-2 bg-yellow-600 text-white text-sm rounded-lg font-semibold text-center whitespace-nowrap';
                                    confirmBtn.innerHTML = '<i class="fas fa-clock mr-1"></i>Payment Pending';
                                }
                            }
                        }
                    }

                    // Check if ride auto-completed
                    if (result.rideCompleted) {
                        console.log('🎉 Ride auto-completed');
                        setTimeout(() => {
                            if (window.LANEApp && window.LANEApp.showAlert) {
                                LANEApp.showAlert('🎉 All passengers dropped off! Ride completed automatically.', 'success');
                            } else {
                                alert('🎉 All passengers dropped off! Ride completed automatically.');
                            }
                            setTimeout(() => {
                                window.location.reload();
                            }, 2000);
                        }, 1000);
                    }
                } else {
                    console.error('❌ Dropoff verification failed:', result.message);
                    if (window.LANEApp && window.LANEApp.showAlert) {
                        LANEApp.showAlert(result.message || '❌ Invalid OTP. Please try again.', 'error');
                    } else {
                        alert(result.message || '❌ Invalid OTP. Please try again.');
                    }
                    otpInput.value = '';
                    otpInput.focus();
                }
            } catch (error) {
                console.error('❌ Verify dropoff OTP error:', error);
                if (window.LANEApp && window.LANEApp.showAlert) {
                    LANEApp.showAlert('Failed to verify OTP. Please try again.', 'error');
                } else {
                    alert('Failed to verify OTP. Please try again.');
                }
            }
        }

        // Mark Payment as Paid
        async function markAsPaid(bookingId) {
            console.log('💰 Mark as Paid called for booking:', bookingId);

            if (!confirm('Confirm that passenger has paid in cash?')) {
                return;
            }

            try {
                if (window.LANEApp && window.LANEApp.showAlert) {
                    LANEApp.showAlert('Processing payment...', 'info');
                }
                console.log('📡 Sending mark as paid request...');

                const response = await fetch(`/bookings/${bookingId}/mark-paid`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                console.log('📥 Mark as paid response:', result);

                if (result.success) {
                    console.log('✅ Payment marked as paid successfully');
                    if (window.LANEApp && window.LANEApp.showAlert) {
                        LANEApp.showAlert('✅ Payment marked as PAID!', 'success');
                    } else {
                        alert('✅ Payment marked as PAID!');
                    }

                    // Reload page to show updated status
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    console.error('❌ Failed to mark payment:', result.message);
                    if (window.LANEApp && window.LANEApp.showAlert) {
                        LANEApp.showAlert(result.message || '❌ Failed to mark payment', 'error');
                    } else {
                        alert(result.message || '❌ Failed to mark payment');
                    }
                }
            } catch (error) {
                console.error('❌ Mark as paid error:', error);
                if (window.LANEApp && window.LANEApp.showAlert) {
                    LANEApp.showAlert('Failed to mark payment. Please try again.', 'error');
                } else {
                    alert('Failed to mark payment. Please try again.');
                }
            }
        }

        // ============================================
        // 🗺️ AUTOMATIC LOCATION TRACKING FOR DRIVERS
        // ============================================
        <% if (ride.rider._id.toString() === user._id.toString() && ['IN_PROGRESS','ACTIVE','PICKUP_PENDING','READY_FOR_PICKUP'].includes(ride.status)) { %>
        let locationWatchId = null;
        let lastLocationUpdate = null;
        const LOCATION_UPDATE_INTERVAL = 10000; // Update every 10 seconds
        const MIN_DISTANCE_THRESHOLD = 10; // meters        // Calculate distance between two coordinates (Haversine formula)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth's radius in meters
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c; // Distance in meters
        }

        // Send location update to server
        async function sendLocationUpdate(position) {
            const { latitude, longitude, speed, accuracy } = position.coords;

            // Check if we should send update (based on time and distance)
            if (lastLocationUpdate) {
                const timeSinceLastUpdate = Date.now() - lastLocationUpdate.timestamp;
                const distance = calculateDistance(
                    lastLocationUpdate.latitude,
                    lastLocationUpdate.longitude,
                    latitude,
                    longitude
                );

                // Don't send if too soon and hasn't moved much
                if (timeSinceLastUpdate < LOCATION_UPDATE_INTERVAL && distance < MIN_DISTANCE_THRESHOLD) {
                    console.log('⏭️ Skipping location update (not enough movement or time)');
                    return;
                }
            }

            try {
                console.log('📍 Sending location update:', { latitude, longitude, speed, accuracy });

                // NOTE: Tracking API is mounted under /tracking
                const response = await fetch('/tracking/api/<%= ride._id %>/location', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        latitude,
                        longitude,
                        speed: speed || 0,
                        accuracy: accuracy || 0
                    })
                });

                const result = await response.json();

                if (result.success) {
                    console.log('✅ Location updated successfully');
                    lastLocationUpdate = {
                        latitude,
                        longitude,
                        timestamp: Date.now()
                    };

                    // Update UI indicator
                    updateLocationIndicator(true);
                } else {
                    console.error('❌ Failed to update location:', result.message);
                    updateLocationIndicator(false);
                }
            } catch (error) {
                console.error('❌ Location update error:', error);
                updateLocationIndicator(false);
            }
        }

        // Update location indicator in UI
        function updateLocationIndicator(success) {
            let indicator = document.getElementById('locationIndicator');
            
            if (!indicator) {
                // Create indicator if it doesn't exist
                const header = document.querySelector('.bg-white.rounded-lg.shadow-md.p-6.mb-6');
                if (header) {
                    indicator = document.createElement('div');
                    indicator.id = 'locationIndicator';
                    indicator.className = 'mt-4 p-3 rounded-lg flex items-center text-sm';
                    header.appendChild(indicator);
                }
            }

            if (indicator) {
                if (success) {
                    indicator.className = 'mt-4 p-3 rounded-lg flex items-center text-sm bg-green-100 text-green-800';
                    indicator.innerHTML = `
                        <i class="fas fa-map-marker-alt animate-pulse mr-2"></i>
                        <span>Live tracking active - Passengers can see your location</span>
                        <span class="ml-auto text-xs">${new Date().toLocaleTimeString()}</span>
                    `;
                } else {
                    indicator.className = 'mt-4 p-3 rounded-lg flex items-center text-sm bg-yellow-100 text-yellow-800';
                    indicator.innerHTML = `
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        <span>Location tracking paused - Retrying...</span>
                    `;
                }
            }
        }

        // Start location tracking
        function startLocationTracking() {
            if (!navigator.geolocation) {
                console.error('❌ Geolocation not supported');
                alert('Your browser does not support location tracking');
                return;
            }

            console.log('🗺️ Starting location tracking...');

            // Watch position with high accuracy
            locationWatchId = navigator.geolocation.watchPosition(
                sendLocationUpdate,
                (error) => {
                    console.error('❌ Geolocation error:', error);
                    updateLocationIndicator(false);
                    
                    switch (error.code) {
                        case error.PERMISSION_DENIED:
                            alert('Please enable location permissions to track your ride');
                            break;
                        case error.POSITION_UNAVAILABLE:
                            console.log('⚠️ Location temporarily unavailable, will retry...');
                            break;
                        case error.TIMEOUT:
                            console.log('⚠️ Location request timed out, will retry...');
                            break;
                    }
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 5000
                }
            );

            console.log('✅ Location tracking started with watch ID:', locationWatchId);
            
            // Show tracking indicator
            updateLocationIndicator(true);
        }

        // Stop location tracking
        function stopLocationTracking() {
            if (locationWatchId !== null) {
                navigator.geolocation.clearWatch(locationWatchId);
                locationWatchId = null;
                console.log('🛑 Location tracking stopped');
            }
        }

        // Start tracking when page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🚗 Ride is IN_PROGRESS/READY_FOR_PICKUP - Starting automatic location tracking');
            startLocationTracking();
        });

        // Stop tracking when leaving page
        window.addEventListener('beforeunload', () => {
            stopLocationTracking();
        });

        // Handle page visibility changes (pause when tab is hidden)
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                console.log('📴 Page hidden - location tracking continues in background');
                // Don't stop - continue tracking in background
            } else {
                console.log('📱 Page visible - location tracking active');
                // Ensure tracking is still active
                if (locationWatchId === null) {
                    startLocationTracking();
                }
            }
        });
        <% } %>
        // ============================================
        // END LOCATION TRACKING
        // ============================================

    </script>

    <%- include('../partials/footer') %>

        ```