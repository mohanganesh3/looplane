<%- include('../partials/header') %>

    <div class="pt-20 pb-12 bg-gray-50 min-h-screen">
        <div class="container mx-auto px-4">
            <!-- Search Header -->
            <div class="bg-white rounded-2xl shadow-lg p-8 mb-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">
                    <i class="fas fa-search text-primary mr-3"></i>Find Your Perfect Ride
                </h1>

                <!-- Search Form -->
                <form id="ride-search-form" action="/rides/search/results" method="get" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <!-- From Location -->
                        <div class="relative">
                            <label class="block text-gray-700 font-medium mb-2">
                                <i class="fas fa-map-marker-alt text-green-600 mr-2"></i>From
                            </label>
                            <input type="text" id="fromLocation" name="from"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                placeholder="Enter pickup location" required autocomplete="off">
                            <input type="hidden" id="fromCoordinates" name="fromCoordinates">
                        </div>

                        <!-- To Location -->
                        <div class="relative">
                            <label class="block text-gray-700 font-medium mb-2">
                                <i class="fas fa-map-marker-alt text-red-600 mr-2"></i>To
                            </label>
                            <input type="text" id="toLocation" name="to"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                placeholder="Enter destination" required autocomplete="off">
                            <input type="hidden" id="toCoordinates" name="toCoordinates">
                        </div>

                        <!-- Date -->
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">
                                <i class="fas fa-calendar text-primary mr-2"></i>Date
                            </label>
                            <input type="date" name="date"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                min="<%= new Date().toISOString().split('T')[0] %>" required>
                        </div>

                        <!-- Passengers -->
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">
                                <i class="fas fa-users text-primary mr-2"></i>Passengers
                            </label>
                            <select name="seats"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="1">1 Passenger</option>
                                <option value="2">2 Passengers</option>
                                <option value="3">3 Passengers</option>
                                <option value="4">4 Passengers</option>
                            </select>
                        </div>
                    </div>

                    <div class="flex justify-center mt-6">
                        <button type="submit"
                            class="bg-primary hover:bg-green-700 text-white px-8 py-3 rounded-lg font-semibold transition-all transform hover:scale-105">
                            <i class="fas fa-search mr-2"></i>Search Rides
                        </button>
                    </div>
                </form>
            </div>

            <!-- Results Section -->
            <div id="search-results">
                <!-- AJAX search results will be injected here -->
            </div>
        <script>
            // Location Autocomplete using Nominatim API
            function initLocationAutocomplete(input, coordsInput) {
                let debounceTimer;
                let suggestionsDiv = null;
                // ...existing code for autocomplete...
            }

            // Traditional AJAX for ride search form
            document.getElementById('ride-search-form').addEventListener('submit', function(e) {
                e.preventDefault();
                var form = e.target;
                var params = [];
                for (var i = 0; i < form.elements.length; i++) {
                    var el = form.elements[i];
                    if (el.name && !el.disabled) {
                        params.push(encodeURIComponent(el.name) + '=' + encodeURIComponent(el.value));
                    }
                }
                var xhr = new XMLHttpRequest();
                xhr.open('GET', '/rides/search/results?' + params.join('&'), true);
                xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4 && xhr.status === 200) { //added xhr
                        document.getElementById('search-results').innerHTML = xhr.responseText;
                    }
                };
                xhr.send();
                    input.parentElement.appendChild(suggestionsDiv);
                }
                return suggestionsDiv;
            };

            // Fetch suggestions from Nominatim API
            const fetchSuggestions = async (query) => {
                if (query.length < 3) {
                    createSuggestionsDiv().classList.add('hidden');
                    return;
                }

                try {
                    const response = await fetch(
                        `https://nominatim.openstreetmap.org/search?` +
                        `format=json&q=${encodeURIComponent(query)}&` +
                        `countrycodes=in&limit=5&addressdetails=1`,
                        {
                            headers: {
                                'User-Agent': 'LANE-Carpool-App'
                            }
                        }
                    );

                    const results = await response.json();
                    displaySuggestions(results);
                } catch (error) {
                    console.error('Error fetching location suggestions:', error);
                }
            };

            // Display suggestions
            const displaySuggestions = (results) => {
                const div = createSuggestionsDiv();

                if (results.length === 0) {
                    div.innerHTML = '<div class="p-3 text-gray-500 text-sm">No locations found</div>';
                    div.classList.remove('hidden');
                    return;
                }

                div.innerHTML = results.map(result => {
                    const displayName = result.display_name;
                    const icon = getLocationIcon(result.type);

                    return `
                <div class="suggestion-item p-3 hover:bg-gray-100 cursor-pointer border-b border-gray-100 last:border-b-0 transition"
                     data-lat="${result.lat}" 
                     data-lon="${result.lon}" 
                     data-display="${displayName}">
                    <div class="flex items-start">
                        <i class="${icon} text-primary mr-3 mt-1"></i>
                        <div class="flex-1">
                            <div class="font-medium text-gray-800 text-sm">${getShortName(result)}</div>
                            <div class="text-xs text-gray-500 mt-0.5">${displayName}</div>
                        </div>
                    </div>
                </div>
            `;
                }).join('');

                div.classList.remove('hidden');

                // Add click handlers
                div.querySelectorAll('.suggestion-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const lat = parseFloat(item.dataset.lat);
                        const lon = parseFloat(item.dataset.lon);
                        const displayName = item.dataset.display;

                        input.value = displayName;

                        if (coordsInput) {
                            coordsInput.value = JSON.stringify({
                                type: 'Point',
                                coordinates: [lon, lat],
                                address: displayName
                            });
                        }

                        div.classList.add('hidden');
                    });
                });
            };

            // Get icon based on location type
            const getLocationIcon = (type) => {
                const iconMap = {
                    'city': 'fas fa-city',
                    'town': 'fas fa-building',
                    'village': 'fas fa-home',
                    'state': 'fas fa-map',
                    'administrative': 'fas fa-map-marked-alt',
                    'road': 'fas fa-road',
                    'railway': 'fas fa-train',
                    'airport': 'fas fa-plane',
                    'hotel': 'fas fa-hotel',
                    'restaurant': 'fas fa-utensils'
                };
                return iconMap[type] || 'fas fa-map-marker-alt';
            };

            // Get short name from result
            const getShortName = (result) => {
                if (result.address) {
                    return result.address.city ||
                        result.address.town ||
                        result.address.village ||
                        result.address.state_district ||
                        result.address.state ||
                        result.name;
                }
                return result.name || result.display_name.split(',')[0];
            };

            // Input event listener with debounce
            input.addEventListener('input', (e) => {
                clearTimeout(debounceTimer);
                const query = e.target.value.trim();

                debounceTimer = setTimeout(() => {
                    fetchSuggestions(query);
                }, 300);
            });

            // Hide suggestions when clicking outside
            document.addEventListener('click', (e) => {
                if (suggestionsDiv && !input.contains(e.target) && !suggestionsDiv.contains(e.target)) {
                    suggestionsDiv.classList.add('hidden');
                }
            });

            // Show suggestions on focus if input has value
            input.addEventListener('focus', () => {
                if (input.value.length >= 3 && suggestionsDiv && suggestionsDiv.children.length > 0) {
                    suggestionsDiv.classList.remove('hidden');
                }
            });
        }

        // Initialize autocomplete for location inputs
        document.addEventListener('DOMContentLoaded', () => {
            initLocationAutocomplete(
                document.getElementById('fromLocation'),
                document.getElementById('fromCoordinates')
            );

            initLocationAutocomplete(
                document.getElementById('toLocation'),
                document.getElementById('toCoordinates')
            );
        });

        document.getElementById('searchForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // Validate that locations are selected from autocomplete
            const fromCoords = document.getElementById('fromCoordinates').value;
            const toCoords = document.getElementById('toCoordinates').value;

            if (!fromCoords || !toCoords) {
                LANEApp.showAlert('Please select valid locations from the dropdown', 'error');
                return;
            }

            // Get form data
            const formData = new FormData(e.target);

            // Build query parameters with coordinate data
            const params = new URLSearchParams({
                origin: fromCoords,
                destination: toCoords,
                date: formData.get('date'),
                seats: formData.get('seats')
            });

            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('resultsSection').classList.remove('hidden');

            try {
                const response = await fetch(`/rides/search/results?${params}`);

                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Response data:', data);

                document.getElementById('loading').classList.add('hidden');

                if (!data || !data.rides) {
                    console.error('Invalid response format:', data);
                    LANEApp.showAlert('Invalid response from server', 'error');
                    return;
                }

                document.getElementById('resultCount').textContent = data.rides.length;

                if (data.rides.length === 0) {
                    document.getElementById('noResults').classList.remove('hidden');
                    document.getElementById('ridesContainer').innerHTML = '';
                } else {
                    document.getElementById('noResults').classList.add('hidden');
                    displayRides(data.rides);
                }
            } catch (error) {
                console.error('Search error:', error);
                document.getElementById('loading').classList.add('hidden');
                LANEApp.showAlert('Failed to search rides: ' + error.message, 'error');
            }
        });

        function displayRides(results) {
            console.log('displayRides called with', results.length, 'results');

            const container = document.getElementById('ridesContainer');
            container.innerHTML = results.map((result, index) => {
                console.log(`Processing result ${index}:`, {
                    hasRide: !!result.ride,
                    carbonSaved: result.carbonSaved,
                    carbonSavedType: typeof result.carbonSaved,
                    price: result.price
                });

                const ride = result.ride;
                return `
        <div class="bg-white rounded-lg shadow-md hover:shadow-xl transition p-6">
            <div class="flex items-start justify-between">
                <div class="flex-1">
                    <div class="flex items-center mb-4">
                        <img src="${ride.rider?.profilePhoto || '/images/default-avatar.png'}" 
                            class="w-12 h-12 rounded-full mr-4" alt="${ride.rider?.name || 'Driver'}">
                        <div>
                            <h3 class="font-semibold text-gray-800">${ride.rider?.name || 'Driver'}</h3>
                            <div class="flex items-center text-sm text-gray-600">
                                <div class="text-yellow-400 mr-2">
                                    ${'★'.repeat(Math.floor(ride.rider?.rating?.overall || 0))}${'☆'.repeat(5 - Math.floor(ride.rider?.rating?.overall || 0))}
                                </div>
                                <span>${ride.rider?.rating?.overall?.toFixed(1) || 'New'}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-2 mb-4">
                        <div class="flex items-center text-gray-700">
                            <i class="fas fa-map-marker-alt text-green-600 w-6"></i>
                            <span class="ml-2">${ride.route?.start?.name || 'Pickup location'}</span>
                        </div>
                        <div class="flex items-center text-gray-700">
                            <i class="fas fa-map-marker-alt text-red-600 w-6"></i>
                            <span class="ml-2">${ride.route?.destination?.name || 'Destination'}</span>
                        </div>
                        <div class="flex items-center text-gray-600 text-sm">
                            <i class="fas fa-clock w-6"></i>
                            <span class="ml-2">${new Date(ride.schedule?.departureDateTime).toLocaleString()}</span>
                        </div>
                        <div class="flex items-center text-gray-600 text-sm">
                            <i class="fas fa-route w-6"></i>
                            <span class="ml-2">${result.distance?.toFixed(1) || ride.route?.distance?.toFixed(1)} km</span>
                            ${result.directDistance ? `<span class="ml-2 text-xs text-gray-400">(direct: ${result.directDistance.toFixed(1)} km)</span>` : ''}
                            ${result.detour && result.detour > 0 ? `<span class="ml-2 px-2 py-0.5 ${result.detour > 15 ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'} rounded text-xs">+${Number(result.detour).toFixed(1)}% route</span>` : ''}
                            ${result.matchQuality ? `<span class="ml-2 px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs font-semibold">${result.matchQuality}</span>` : ''}
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-4 text-sm text-gray-600">
                        <span><i class="fas fa-users mr-1"></i>${ride.pricing?.availableSeats || 0} seats</span>
                        <span><i class="fas fa-car mr-1"></i>${ride.vehicleDetails?.model || ride.vehicle?.model || 'Vehicle'}</span>
                        ${result.carbonSaved && typeof result.carbonSaved === 'number' ? `<span class="text-green-600"><i class="fas fa-leaf mr-1"></i>${result.carbonSaved.toFixed(1)}kg CO₂ saved</span>` : ''}
                    </div>
                </div>
                
                <div class="text-right">
                    <div class="text-2xl font-bold text-primary mb-2">₹${result.price || ride.pricing?.pricePerSeat || 0}</div>
                    <a href="/rides/${ride._id}" class="bg-primary hover:bg-green-700 text-white px-6 py-2 rounded-lg font-semibold transition inline-block">
                        View Details
                    </a>
                </div>
            </div>
        </div>
    `}).join('');
        }
    </script>

    <%- include('../partials/footer') %>