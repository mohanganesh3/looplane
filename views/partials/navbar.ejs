<nav class="bg-white shadow-lg fixed w-full top-0 z-50">
    <div class="container mx-auto px-4">
        <div class="flex justify-between items-center h-16">
            <!-- Logo -->
            <div class="flex items-center">
                <a href="/" class="flex items-center space-x-2">
                    <i class="fas fa-car text-primary text-2xl"></i>
                    <span class="text-2xl font-bold text-gray-800">LANE</span>
                </a>
            </div>

            <!-- Desktop Navigation -->
            <div class="hidden md:flex items-center space-x-6">
                <% if (user) { %>
                    <!-- Authenticated User Menu -->
                    <a href="/rides/search" class="text-gray-700 hover:text-primary transition">
                        <i class="fas fa-search mr-1"></i> Search Rides
                    </a>

                    <% if (user.role==='RIDER' ) { %>
                        <a href="/rides/post" class="text-gray-700 hover:text-primary transition">
                            <i class="fas fa-plus-circle mr-1"></i> Post Ride
                        </a>
                        <a href="/rides/my-rides" class="text-gray-700 hover:text-primary transition">
                            <i class="fas fa-route mr-1"></i> My Rides
                        </a>
                        <a href="/bookings/my-bookings" class="text-gray-700 hover:text-primary transition">
                            <i class="fas fa-ticket-alt mr-1"></i> My Bookings
                        </a>
                    <% } else { %>
                    <a href="/bookings/my-bookings" class="text-gray-700 hover:text-primary transition">
                        <i class="fas fa-ticket-alt mr-1"></i> My Bookings
                    </a>
                <% } %>

                                <a href="/chat" class="text-gray-700 hover:text-primary transition relative">
                                    <i class="fas fa-comments mr-1"></i> Messages
                                    <span
                                        class="absolute -top-1 -right-2 bg-red-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center shadow-lg"
                                        id="unreadCount" style="display: none;"></span>
                                </a>

                                <!-- Notifications Dropdown -->
                                <div class="relative" x-data="{ notificationsOpen: false }">
                                    <button
                                        @click="notificationsOpen = !notificationsOpen; if(notificationsOpen) loadNotifications()"
                                        class="text-gray-700 hover:text-primary transition relative">
                                        <i class="fas fa-bell text-xl"></i>
                                        <span id="notificationBadge"
                                            class="absolute -top-1 -right-2 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center"
                                            style="display: none;">0</span>
                                    </button>

                                    <div x-show="notificationsOpen" @click.away="notificationsOpen = false"
                                        class="absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-2xl z-50 max-h-96 overflow-hidden flex flex-col">
                                        <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                                            <h3 class="font-semibold text-gray-800">Notifications</h3>
                                            <button onclick="markAllAsRead()"
                                                class="text-xs text-primary hover:underline">Mark all read</button>
                                        </div>
                                        <div id="notificationsList" class="overflow-y-auto flex-1">
                                            <div class="p-8 text-center text-gray-400">
                                                <i class="fas fa-bell-slash text-4xl mb-2"></i>
                                                <p class="text-sm">No notifications yet</p>
                                            </div>
                                        </div>
                                        <div class="p-2 border-t border-gray-200 text-center">
                                            <a href="/user/notifications"
                                                class="text-sm text-primary hover:underline">View all notifications</a>
                                        </div>
                                    </div>
                                </div>

                                <!-- User Dropdown -->
                                <div class="relative" x-data="{ open: false }">
                                    <button @click="open = !open"
                                        class="flex items-center space-x-2 text-gray-700 hover:text-primary transition">
                                        <img src="<%= user.profilePhoto || user?.profile?.photo || '/images/default-avatar.png' %>"
                                            alt="<%= getUserName(user) %>" class="w-8 h-8 rounded-full object-cover">
                                        <span>
                                            <%= getUserName(user) %>
                                        </span>
                                        <i class="fas fa-chevron-down text-xs"></i>
                                    </button>

                                    <div x-show="open" @click.away="open = false"
                                        class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl py-2 z-50">
                                        <a href="/user/dashboard"
                                            class="block px-4 py-2 text-gray-700 hover:bg-gray-100">
                                            <i class="fas fa-tachometer-alt mr-2"></i> Dashboard
                                        </a>
                                        <a href="/user/profile" class="block px-4 py-2 text-gray-700 hover:bg-gray-100">
                                            <i class="fas fa-user mr-2"></i> Profile
                                        </a>
                                        <a href="/user/trip-history"
                                            class="block px-4 py-2 text-gray-700 hover:bg-gray-100">
                                            <i class="fas fa-history mr-2"></i> Trip History
                                        </a>
                                        <a href="/user/settings"
                                            class="block px-4 py-2 text-gray-700 hover:bg-gray-100">
                                            <i class="fas fa-cog mr-2"></i> Settings
                                        </a>
                                        <% if (user.role==='ADMIN' ) { %>
                                            <hr class="my-2">
                                            <a href="/admin/dashboard"
                                                class="block px-4 py-2 text-gray-700 hover:bg-gray-100">
                                                <i class="fas fa-crown mr-2 text-yellow-500"></i> Admin Panel
                                            </a>
                                            <% } %>
                                                <hr class="my-2">
                                                <a href="/user/chat-test"
                                                    class="block px-4 py-2 text-indigo-600 hover:bg-indigo-50">
                                                    <i class="fas fa-bug mr-2"></i> Chat Debug
                                                </a>
                                                <hr class="my-2">
                                                <a href="/auth/logout"
                                                    class="block px-4 py-2 text-red-600 hover:bg-red-50">
                                                    <i class="fas fa-sign-out-alt mr-2"></i> Logout
                                                </a>
                                    </div>
                                </div>

                                <!-- SOS Button -->
                                <a href="/sos/emergency"
                                    class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition flex items-center space-x-2">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <span>SOS</span>
                                </a>
                                <% } else { %>
                                    <!-- Guest Menu -->
                                    <a href="/" class="text-gray-700 hover:text-primary transition">Home</a>
                                    <a href="/rides/search" class="text-gray-700 hover:text-primary transition">Search
                                        Rides</a>
                                    <a href="/auth/login" class="text-gray-700 hover:text-primary transition">Login</a>
                                    <a href="/auth/register"
                                        class="bg-primary hover:bg-green-600 text-white px-6 py-2 rounded-lg transition">Sign
                                        Up</a>
                                    <% } %>
            </div>

            <!-- Mobile Menu Button -->
            <button class="md:hidden text-gray-700" onclick="toggleMobileMenu()">
                <i class="fas fa-bars text-2xl"></i>
            </button>
        </div>
    </div>

    <!-- Mobile Menu -->
    <div id="mobileMenu" class="hidden md:hidden bg-white border-t">
        <div class="px-4 py-4 space-y-3">
            <% if (user) { %>
                <a href="/rides/search" class="block text-gray-700 hover:text-primary transition">
                    <i class="fas fa-search mr-2"></i> Search Rides
                </a>
                <% if (user.role==='RIDER' ) { %>
                    <a href="/rides/post" class="block text-gray-700 hover:text-primary transition">
                        <i class="fas fa-plus-circle mr-2"></i> Post Ride
                    </a>
                    <a href="/rides/my-rides" class="block text-gray-700 hover:text-primary transition">
                        <i class="fas fa-route mr-2"></i> My Rides
                    </a>
                    <a href="/bookings/my-bookings" class="block text-gray-700 hover:text-primary transition">
                        <i class="fas fa-ticket-alt mr-2"></i> My Bookings
                    </a>
                <% } else { %>
                    <a href="/bookings/my-bookings" class="block text-gray-700 hover:text-primary transition">
                        <i class="fas fa-ticket-alt mr-2"></i> My Bookings
                    </a>
                <% } %>
                
                <!-- SOS (Mobile) -->
                <a href="/sos/emergency" class="block bg-red-600 text-white hover:bg-red-700 transition px-4 py-2 rounded-lg text-center mt-2">
                    <i class="fas fa-exclamation-triangle mr-2"></i> SOS Emergency
                </a>
                
                <a href="/user/dashboard" class="block text-gray-700 hover:text-primary transition mt-2">
                    <i class="fas fa-tachometer-alt mr-2"></i> Dashboard
                </a>
                <a href="/auth/logout" class="block text-red-600 hover:text-red-700 transition">
                    <i class="fas fa-sign-out-alt mr-2"></i> Logout
                </a>
            <% } else { %>
                            <a href="/auth/login" class="block text-gray-700 hover:text-primary transition">Login</a>
                            <a href="/auth/register" class="block text-primary hover:text-green-600 transition">Sign
                                Up</a>
                            <% } %>
        </div>
    </div>
</nav>

<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
<script>
    function toggleMobileMenu() {
        const menu = document.getElementById('mobileMenu');
        menu.classList.toggle('hidden');
    }
</script>